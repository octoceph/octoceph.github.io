<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OctoCore Dashboard</title>
<style>
  /* –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏: –ª–µ–≤—ã–π —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–∞–π–¥–±–∞—Ä –∏ –æ—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å */
  body { margin: 0; font-family: Arial, sans-serif; display: flex; height: 100vh; background:#071423; color:#e6eef6 }
  #sidebar { width: 320px; background: #0f1724; color: white; padding: 12px; overflow-y: auto; position: fixed; left: 0; top: 0; bottom: 0; box-shadow: 6px 0 20px rgba(0,0,0,.6); }
  #sidebar h3{margin-top:0}
  #main { flex: 1; margin-left: 320px; display: flex; flex-direction: column; min-height:100vh }
  header { background: linear-gradient(90deg,#07182a,#0b2633); color: white; padding: 12px; display: flex; justify-content: space-between; align-items: center; border-bottom:1px solid rgba(255,255,255,0.02) }

  /* –ù–∞–≤–∏–≥–∞—Ü–∏—è –≤–∫–ª–∞–¥–æ–∫ */
  nav { display: flex; background: #07202a; color: white }
  nav button { flex: 1; padding: 10px; background: none; border: none; color: #bfeef9; cursor: pointer }
  nav button.active { background: linear-gradient(90deg,#05343a,#024b4f); color: white }

  .content { padding: 12px; overflow:auto }

  /* –û–±–ª–∞—Å—Ç—å –∫–∞–º–µ—Ä: –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞ —à–∏—Ä–∏–Ω–æ–π viewport */
  .camera-container { display:flex; flex-wrap:wrap; gap:12px; max-width:100vw }

  /* –ö–∞—Ä—Ç–æ—á–∫–∞ –∫–∞–º–µ—Ä—ã: –≤–∏–¥–µ–æ + –∫–Ω–æ–ø–∫–∏ (snapshot bottom-left, ai bottom-right, delete top-right) */
  .camera { position: relative; width: 320px; background: #061219; border-radius:8px; padding:6px; box-shadow: 0 6px 24px rgba(2,6,23,.6); }
  .camera video { width:100%; height: auto; border-radius:6px; background:black; display:block }
  .camera .btn-top-right { position:absolute; top:10px; right:10px; background:#ef4444; color:white; border:none; padding:6px 8px; border-radius:6px; cursor:pointer }
  .camera .btn-bottom-right { position:absolute; bottom:10px; right:10px; background:#06b6d4; color:#012; border:none; padding:6px 8px; border-radius:6px; cursor:pointer }
  .camera .btn-bottom-left { position:absolute; bottom:10px; left:10px; background:linear-gradient(90deg,#ffd166,#ff7a00); color:#012; border:none; padding:6px 8px; border-radius:6px; cursor:pointer; display:flex; gap:6px; align-items:center }

  /* –í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π —Ä—è–¥–æ–º —Å –∫–Ω–æ–ø–∫–æ–π –ò–ò */
  .model-select { position:absolute; bottom:46px; right:10px; display:none; flex-direction:column; gap:6px; }
  .model-select select{padding:6px;border-radius:6px;background:#052028;border:1px solid rgba(255,255,255,0.04);color:#e6eef6}
  .model-select button{padding:6px;border-radius:6px;background:#06b6d4;color:#012;border:none}

  /* –ì–∞–ª–µ—Ä–µ–∏: –∫–∞–∂–¥–∞—è –≥–∞–ª–µ—Ä–µ—è - –±–ª–æ–∫ —Å –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–º —Ç–∞–π–º–ª–∞–π–Ω–æ–º (scroll-x) */
  .gallery-block{ background:#071827; padding:10px; border-radius:8px; margin-bottom:12px }
  .timeline { display:flex; gap:8px; overflow:auto; padding:6px }
  .timeline img{ height:96px; border-radius:6px }

  /* –õ–æ–≥–∏ –∫–∞–∫ –≤ –∫–æ–Ω—Å–æ–ª–∏: —Å—Ç—Ä–æ—á–∫–∞ –ø–æ–¥ —Å—Ç—Ä–æ—á–∫–æ–π */
  #logConsole { background:#000; color:#0f0; padding:8px; font-family: monospace; height:220px; overflow:auto; border-radius:6px; border:1px solid rgba(255,255,255,0.02) }

  /* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
  @media(max-width:900px){ #sidebar{ position:relative; width:100%; height:auto } #main{ margin-left:0 } }
</style>
</head>
<body>
  <!-- –°–∞–π–¥–±–∞—Ä —Å–ª–µ–≤–∞: –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –º–æ–¥–µ–ª–∏, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –¥–µ–π—Å—Ç–≤–∏—è -->
  <div id="sidebar">
    <h3>–ú–µ–Ω—é OctoCore</h3>
    <div style="margin-bottom:8px">–ö–∞–º–µ—Ä—ã ¬∑ AI ¬∑ –•—Ä–∞–Ω–µ–Ω–∏–µ</div>

    <button onclick="addCamera()" style="width:100%;margin-bottom:8px;padding:8px;border-radius:6px;background:#06b6d4;color:#012;border:none;cursor:pointer">–î–æ–±–∞–≤–∏—Ç—å –≤–µ–±-–∫–∞–º–µ—Ä—É</button>

    <h4 style="margin:8px 0 6px">IP-–∫–∞–º–µ—Ä–∞</h4>
    <input id="ipCamUrl" placeholder="URL IP –∫–∞–º–µ—Ä—ã" style="width:100%;padding:8px;margin-bottom:6px;border-radius:6px;background:#02171a;color:#e6eef6;border:1px solid rgba(255,255,255,0.03)" />
    <div style="display:flex;gap:6px;margin-bottom:8px">
      <input id="ipCamLogin" placeholder="–õ–æ–≥–∏–Ω" style="flex:1;padding:8px;border-radius:6px;background:#02171a;color:#e6eef6;border:1px solid rgba(255,255,255,0.03)" />
      <input id="ipCamPass" placeholder="–ü–∞—Ä–æ–ª—å" type="password" style="width:120px;padding:8px;border-radius:6px;background:#02171a;color:#e6eef6;border:1px solid rgba(255,255,255,0.03)" />
    </div>
    <button onclick="addIPCamera()" style="width:100%;padding:8px;border-radius:6px;background:#0ea5a0;border:none;color:#012;cursor:pointer">–î–æ–±–∞–≤–∏—Ç—å IP-–∫–∞–º–µ—Ä—É</button>

    <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0" />

    <h4 style="margin:6px 0">–ì–ª–æ–±–∞–ª—å–Ω—ã–µ –º–æ–¥–µ–ª–∏</h4>
    <div style="display:flex;gap:6px;margin-bottom:8px">
      <select id="globalModel" style="flex:1;padding:8px;border-radius:6px;background:#02171a;color:#e6eef6;border:1px solid rgba(255,255,255,0.03)"></select>
      <button onclick="uploadModel()" style="padding:8px;border-radius:6px;background:#06b6d4;border:none;color:#012">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
    </div>
    <div style="font-size:.85rem;color:#94a3b8;margin-bottom:12px">–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å ‚Äî –æ–Ω–∞ —Å—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –∫–∞–∂–¥–æ–π –∫–∞—Ä—Ç–æ—á–∫–µ –∫–∞–º–µ—Ä—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –æ–¥–Ω–æ–≥–æ —Å–Ω–∏–º–∫–∞ –∏–ª–∏ –≤—Å–µ–≥–æ —Ç–∞–π–º–ª–∞–ø—Å–∞.</div>

    <button onclick="restartCameras()" style="width:100%;margin-bottom:8px;padding:8px;border-radius:6px;background:#3b82f6;border:none;color:white;cursor:pointer">–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ</button>
    <button onclick="scanNetwork()" style="width:100%;margin-bottom:8px;padding:8px;border-radius:6px;background:#60a5fa;border:none;color:white;cursor:pointer">–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ç—å</button>

    <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0" />

    <button onclick="showIPFSRecords()" style="width:100%;padding:8px;border-radius:6px;background:#0ea5a0;border:none;color:#012;cursor:pointer">–ü–æ–∫–∞–∑–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ CID</button>

    <div style="margin-top:12px">
      <div style="font-size:.9rem;color:#9ca3af;margin-bottom:6px">–õ–æ–≥–∏ (–∫–æ–Ω—Å–æ–ª—å)</div>
      <div id="logConsole"></div>
    </div>
  </div>

  <!-- –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å —Å–ø—Ä–∞–≤–∞ -->
  <div id="main">
    <header>
      <div>
        <strong>OctoCore</strong>
        <div style="font-size:.85rem;color:#94a3b8">–í–µ–± –¥–∞—à–±–æ—Ä–¥ ‚Äî –∫–∞–º–µ—Ä—ã, AI-–∞–Ω–∞–ª–∏–∑, IPFS</div>
      </div>
      <div>
        <button onclick="toggleSidebar()" style="padding:8px;border-radius:6px;background:#05323a;border:none;color:#e6eef6;cursor:pointer">–°–≤–µ—Ä–Ω—É—Ç—å –º–µ–Ω—é</button>
      </div>
    </header>

    <nav>
      <button id="tabBtnCams" class="active" onclick="showTab('cams')">–ö–∞–º–µ—Ä—ã</button>
      <button id="tabBtnGalleries" onclick="showTab('galleries')">–ì–∞–ª–µ—Ä–µ–∏</button>
      <button id="tabBtnTl" onclick="showTab('timelapses')">–¢–∞–π–º–ª–∞–ø—Å—ã</button>
    </nav>

    <div class="content">
      <section id="cams" class="tab active">
        <h3>–ö–∞–º–µ—Ä—ã</h3>
        <div class="camera-container" id="cameraContainer"></div>
      </section>

      <section id="galleries" class="tab" style="display:none">
        <h3>–ì–∞–ª–µ—Ä–µ–∏</h3>
        <div id="galleriesList"></div>
      </section>

      <section id="timelapses" class="tab" style="display:none">
        <h3>–¢–∞–π–º–ª–∞–ø—Å—ã</h3>
        <div id="timelapsesList"></div>
      </section>
    </div>
  </div>

  <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º TensorFlow.js –∏ MobileNet –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –∞–Ω–∞–ª–∏–∑–∞ -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.12.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0/dist/mobilenet.min.js"></script>

<script>
/*
  –û–±—ä—è—Å–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π:
  - –ö–∞—Ä—Ç–æ—á–∫–∞ –∫–∞–º–µ—Ä—ã —Ç–µ–ø–µ—Ä—å –∏–º–µ–µ—Ç –∫–Ω–æ–ø–∫—É "–°–ù–ò–ú–û–ö" (–∏–∫–æ–Ω–∫–∞ —Ñ–æ—Ç–æ–∞–ø–ø–∞—Ä–∞—Ç–∞) –≤ –ª–µ–≤–æ–º –Ω–∏–∂–Ω–µ–º —É–≥–ª—É.
  - –†—è–¥–æ–º —Å –∫–Ω–æ–ø–∫–æ–π –ò–ò –¥–æ–±–∞–≤–ª–µ–Ω –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π; –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –º–æ–¥–µ–ª–∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è
    –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑: –ª–∏–±–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ —á–µ—Ä–µ–∑ MobileNet (–∫–ª–∞—Å–∏—Ñ–∏–∫–∞—Ü–∏—è),
    –ª–∏–±–æ –≤—ã–¥–µ–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç—É—Ä–æ–≤ (Sobel) –∏ –ø–æ–¥—Å—á—ë—Ç –æ—á–µ—Ä—á–µ–Ω–Ω—ã—Ö –ø–∏–∫—Å–µ–ª–µ–π —Å –ø–æ–º–æ—â—å—é TensorFlow.js.
  - –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –∏ –¥–µ–π—Å—Ç–≤–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª—å-–ø–∞–Ω–µ–ª—å —Å–ª–µ–≤–∞ (—Å—Ç—Ä–æ–∫–æ–π –ø–æ–¥ —Å—Ç—Ä–æ–∫–æ–π).
*/

// –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
const state = {
  cameras: [], // {id, stream, el, video, overlayCanvas}
  models: ['Sobel (tfjs)', 'MobileNet (tfjs)'],
  modelInstances: {}, // –∫—ç—à –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π, –Ω–∞–ø—Ä. mobilenet
  galleries: []
};

// –•–µ–ª–ø–µ—Ä—ã
const $ = id => document.getElementById(id);
function logMessage(msg){ const el = $('logConsole'); const time = new Date().toLocaleTimeString(); el.innerHTML += `[${time}] ${msg}<br>`; el.scrollTop = el.scrollHeight; }

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–ø–∏—Å–∫–∞ –º–æ–¥–µ–ª–µ–π
function updateModelList(){ const sel = $('globalModel'); sel.innerHTML = state.models.map(m => `<option>${m}</option>`).join(''); }
updateModelList();

// –°–∫—Ä—ã—Ç—å/–ø–æ–∫–∞–∑–∞—Ç—å —Å–∞–π–¥–±–∞—Ä
let sidebarVisible = true;
function toggleSidebar(){ sidebarVisible = !sidebarVisible; document.getElementById('sidebar').style.display = sidebarVisible ? 'block' : 'none'; }

// –í–∫–ª–∞–¥–∫–∏
function showTab(id){ ['tabBtnCams','tabBtnGalleries','tabBtnTl'].forEach(b=>$(b).classList.remove('active')); ['cams','galleries','timelapses'].forEach(s=>$(s).style.display='none');
  if(id==='cams'){ $('tabBtnCams').classList.add('active'); $('cams').style.display='block' }
  if(id==='galleries'){ $('tabBtnGalleries').classList.add('active'); $('galleries').style.display='block' }
  if(id==='timelapses'){ $('tabBtnTl').classList.add('active'); $('timelapses').style.display='block' }
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤–µ–±-–∫–∞–º–µ—Ä—ã
async function addCamera(){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
    createCameraCard(stream);
    logMessage('–í–µ–±-–∫–∞–º–µ—Ä–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞');
  }catch(e){ logMessage('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ: ' + (e.message || e)); alert('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ: ' + (e.message || e)); }
}

function createCameraCard(stream){
  const id = 'cam_' + Math.random().toString(36).slice(2,9);
  const el = document.createElement('div'); el.className = 'camera'; el.dataset.camId = id;
  const video = document.createElement('video'); video.autoplay = true; video.playsInline = true; video.muted = true; video.srcObject = stream;

  // overlay canvas: –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –∫–æ–Ω—Ç—É—Ä–æ–≤ –ø–æ–≤–µ—Ä—Ö –≤–∏–¥–µ–æ
  const overlay = document.createElement('canvas'); overlay.style.position='absolute'; overlay.style.left='6px'; overlay.style.top='6px'; overlay.style.pointerEvents='none'; overlay.style.borderRadius='6px';

  // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–∏—Ç—å (–≤–µ—Ä—Ö–Ω–∏–π –ø—Ä–∞–≤—ã–π —É–≥–æ–ª)
  const btnDel = document.createElement('button'); btnDel.textContent = '–£–¥–∞–ª–∏—Ç—å'; btnDel.className = 'btn-top-right'; btnDel.onclick = ()=>{
    try{ stream.getTracks().forEach(t=>t.stop()); }catch(e){}
    el.remove(); state.cameras = state.cameras.filter(c=>c.id!==id); logMessage('–ö–∞–º–µ—Ä–∞ —É–¥–∞–ª–µ–Ω–∞: '+id);
  };

  // –ö–Ω–æ–ø–∫–∞ –°–ù–ò–ú–û–ö (–Ω–∏–∂–Ω–∏–π –ª–µ–≤—ã–π —É–≥–æ–ª) —Å –∏–∫–æ–Ω–∫–æ–π —Ñ–æ—Ç–æ–∞–ø–ø–∞—Ä–∞—Ç–∞
  const btnSnap = document.createElement('button'); btnSnap.className = 'btn-bottom-left'; btnSnap.title = '–°–¥–µ–ª–∞—Ç—å —Å–Ω–∏–º–æ–∫';
  btnSnap.innerHTML = 'üì∑ –°–ù–ò–ú–û–ö';
  btnSnap.onclick = async ()=>{
    try{
      const blob = await captureImageFromVideo(video);
      addSnapshotToGallery(blob);
      logMessage('–°–Ω–∏–º–æ–∫ —Å–¥–µ–ª–∞–Ω –∏ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –≥–∞–ª–µ—Ä–µ—é');
    }catch(e){ logMessage('–û—à–∏–±–∫–∞ —Å–Ω–∏–º–∫–∞: '+e.message); }
  };

  // –ö–Ω–æ–ø–∫–∞ –ò–ò (–Ω–∏–∂–Ω–∏–π –ø—Ä–∞–≤—ã–π) –∏ –≤—ã–ø–∞–¥–∞—é—â–∏–π –≤—ã–±–æ—Ä –º–æ–¥–µ–ª–∏
  const btnAI = document.createElement('button'); btnAI.className = 'btn-bottom-right'; btnAI.textContent = '–ò–ò';
  const modelBox = document.createElement('div'); modelBox.className = 'model-select';
  const select = document.createElement('select'); select.style.minWidth='160px';
  select.innerHTML = state.models.map(m=>`<option>${m}</option>`).join('');
  const runBtn = document.createElement('button'); runBtn.textContent = '–ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑';
  modelBox.appendChild(select); modelBox.appendChild(runBtn);

  // –ü–æ–∫–∞–∑/—Å–∫—Ä—ã—Ç–∏–µ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –ò–ò
  btnAI.onclick = ()=>{ modelBox.style.display = modelBox.style.display === 'flex' ? 'none' : 'flex'; }

  // –ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∞–Ω–∞–ª–∏–∑–∞ ‚Äî –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –∫–∞–¥—Ä –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –º–æ–¥–µ–ª–∏
  runBtn.onclick = async ()=>{
    const modelName = select.value;
    logMessage(`–ó–∞–ø—É—Å–∫ –ò–ò-–∞–Ω–∞–ª–∏–∑–∞ (–∫–∞–º–µ—Ä–∞ ${id}) –º–æ–¥–µ–ª—å: ${modelName}`);
    try{
      const imgCanvas = await captureCanvasFromVideo(video);
      await runAIAnalysisOnCanvas(imgCanvas, modelName, overlay);
    }catch(e){ logMessage('–û—à–∏–±–∫–∞ AI: '+e.message); }
  };

  // –°–æ–±–∏—Ä–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É
  el.appendChild(video);
  el.appendChild(overlay);
  el.appendChild(btnDel);
  el.appendChild(btnSnap);
  el.appendChild(btnAI);
  el.appendChild(modelBox);
  $('cameraContainer').appendChild(el);

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
  state.cameras.push({ id, stream, el, video, overlay });

  // –ü–æ–¥–≥–æ–Ω—è–µ–º —Ä–∞–∑–º–µ—Ä overlay –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ metadata
  video.addEventListener('loadedmetadata', ()=>{
    overlay.width = video.videoWidth || video.clientWidth;
    overlay.height = video.videoHeight || video.clientHeight;
    overlay.style.width = video.clientWidth + 'px';
    overlay.style.height = video.clientHeight + 'px';
  });
}

// –§—É–Ω–∫—Ü–∏—è –∑–∞—Ö–≤–∞—Ç–∞ –∫–∞–¥—Ä–∞ –≤ Blob
function captureImageFromVideo(videoEl, mime='image/png', quality=0.92){
  return new Promise((resolve,reject)=>{
    try{
      const w = videoEl.videoWidth || videoEl.clientWidth || 640;
      const h = videoEl.videoHeight || videoEl.clientHeight || 480;
      const canvas = document.createElement('canvas'); canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d'); ctx.drawImage(videoEl, 0, 0, w, h);
      canvas.toBlob(blob => resolve(blob), mime, quality);
    }catch(e){ reject(e); }
  });
}

// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç canvas —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º —Ç–µ–∫—É—â–µ–≥–æ –∫–∞–¥—Ä–∞
function captureCanvasFromVideo(videoEl){
  return new Promise((resolve,reject)=>{
    try{
      const w = videoEl.videoWidth || videoEl.clientWidth || 640;
      const h = videoEl.videoHeight || videoEl.clientHeight || 480;
      const canvas = document.createElement('canvas'); canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d'); ctx.drawImage(videoEl, 0, 0, w, h);
      resolve(canvas);
    }catch(e){ reject(e); }
  });
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–Ω–∏–º–∫–∞ –≤ –ø—Ä–æ—Å—Ç—É—é –≥–∞–ª–µ—Ä–µ—é (–¥–æ–±–∞–≤–ª—è–µ–º –º–∏–Ω–∏–∞—Ç—é—Ä—É –≤ —Ä–∞–∑–¥–µ–ª –ì–∞–ª–µ—Ä–µ–∏)
function addSnapshotToGallery(blob){
  const url = URL.createObjectURL(blob);
  // –ï—Å–ª–∏ –Ω–µ—Ç –≥–∞–ª–µ—Ä–µ–∏ ‚Äî —Å–æ–∑–¥–∞—ë–º –ø—Ä–æ—Å—Ç—É—é
  if(state.galleries.length === 0){ state.galleries.push({ id:'g_default', name:'Main Gallery', items:[] }); }
  const g = state.galleries[0];
  const item = { id: 'it_' + Math.random().toString(36).slice(2,8), src: url, blob };
  g.items.push(item);
  renderGalleries();
}

function renderGalleries(){
  const container = $('galleriesList'); container.innerHTML = '';
  state.galleries.forEach(g =>{
    const block = document.createElement('div'); block.className='gallery-block';
    const title = document.createElement('div'); title.innerHTML = `<strong>${g.name}</strong> <span style=\"color:#9ca3af;margin-left:8px\">(${g.items.length} items)</span>`;
    const timeline = document.createElement('div'); timeline.className='timeline';
    g.items.forEach(it=>{
      const img = document.createElement('img'); img.src = it.src; timeline.appendChild(img);
    });
    block.appendChild(title); block.appendChild(timeline); container.appendChild(block);
  });
}

// –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –≤—Å–µ—Ö –∫–∞–º–µ—Ä: –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º (–≤ –±—Ä–∞—É–∑–µ—Ä–µ —Å–ª–æ–∂–Ω–æ—Å—Ç—å —Å deviceId; –º—ã –ø–æ–ø—ã—Ç–∞–µ–º—Å—è –∑–∞–ø—Ä–æ—Å–∏—Ç—å —Å–Ω–æ–≤–∞)
async function restartCameras(){
  logMessage('–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –≤—Å–µ—Ö –∫–∞–º–µ—Ä...');
  // –û—Å—Ç–∞–Ω–æ–≤–∏–º —Å—Ç–∞—Ä—ã–µ
  state.cameras.forEach(c=>{ try{ c.stream.getTracks().forEach(t=>t.stop()); }catch(e){} if(c.el && c.el.parentNode) c.el.parentNode.removeChild(c.el); });
  state.cameras = [];
  // –ü–æ–ø—Ä–æ–±—É–µ–º –æ—Ç–∫—Ä—ã—Ç—å –æ–¥–Ω—É –∫–∞–º–µ—Ä—É –∑–∞–Ω–æ–≤–æ
  try{ await addCamera(); logMessage('–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∑–∞–≤–µ—Ä—à—ë–Ω'); }catch(e){ logMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ: '+e.message); }
}

function scanNetwork(){ logMessage('–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Ç–∏ (–¥–µ–º–æ) ‚Äî –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–µ—Ä–≤–µ—Ä–Ω—ã–π –ø—Ä–æ–∫—Å–∏'); }
function addIPCamera(){ const url = $('ipCamUrl').value.trim(); if(!url){ alert('–í–≤–µ–¥–∏—Ç–µ URL'); return; } // –≤—Å—Ç–∞–≤–∏–º –∫–∞–∫ –∫–∞—Ä—Ç–∏–Ω–∫—É
  const id = 'ip_' + Math.random().toString(36).slice(2,8);
  const el = document.createElement('div'); el.className='camera'; el.dataset.camId = id;
  const img = document.createElement('img'); img.src = url; img.style.width='100%'; img.style.borderRadius='6px';
  const btnDel = document.createElement('button'); btnDel.textContent='–£–¥–∞–ª–∏—Ç—å'; btnDel.className='btn-top-right'; btnDel.onclick=()=>{ el.remove(); logMessage('IP –∫–∞–º–µ—Ä–∞ —É–¥–∞–ª–µ–Ω–∞: '+id); };
  el.appendChild(img); el.appendChild(btnDel); $('cameraContainer').appendChild(el); logMessage('IP –∫–∞–º–µ—Ä–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞: '+url); }

function uploadModel(){ const name = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ (Sobel (tfjs) –∏–ª–∏ MobileNet (tfjs) —Ä–µ–∫–æ–º–µ–Ω–¥—É—é—Ç—Å—è)'); if(!name) return; state.models.push(name); updateModelList(); // –æ–±–Ω–æ–≤–∏–º —Å–µ–ª–µ–∫—Ç—ã –≤ –∫–∞–∂–¥—É—é –∫–∞—Ä—Ç–æ—á–∫—É
  document.querySelectorAll('.model-select select').forEach(s=>{ s.innerHTML = state.models.map(m=>`<option>${m}</option>`).join(''); }); logMessage('–ú–æ–¥–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω–∞: '+name); }

// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ CID (localStorage) ‚Äî –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è
function showIPFSRecords(){ const raw = localStorage.getItem('octocore_ipfs_records') || '[]'; const w = window.open(); w.document.body.style.background='#071423'; w.document.body.style.color='#e6eef6'; const pre = w.document.createElement('pre'); pre.textContent = raw; w.document.body.appendChild(pre); }

// ===================== AI: —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è Sobel –∏ MobileNet —á–µ—Ä–µ–∑ tfjs =====================

async function runAIAnalysisOnCanvas(canvas, modelName, overlayCanvas){
  // modelName: —Å—Ç—Ä–æ–∫–∞, overlayCanvas: canvas (overlay) —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
  if(modelName.includes('Sobel')){
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º tfjs –¥–ª—è —Å–≤—ë—Ä—Ç–∫–∏ Sobel –∏ –ø–æ–¥—Å—á—ë—Ç–∞ –æ—á–µ—Ä—á–µ–Ω–Ω—ã—Ö –ø–∏–∫—Å–µ–ª–µ–π
    logMessage('AI: Sobel edge detection (tfjs) ‚Äî —Å—Ç–∞—Ä—Ç');
    await tf.ready();
    const t = tf.tidy(()=>{
      // –°–æ–∑–¥–∞–¥–∏–º —Ç–µ–Ω–∑–æ—Ä [1, H, W, 1] –∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –≥—Ä–∞–¥–∞—Ü–∏—è—Ö —Å–µ—Ä–æ–≥–æ
      let img = tf.browser.fromPixels(canvas).mean(2).toFloat(); // [H,W]
      const expanded = img.expandDims(0).expandDims(-1); // [1,H,W,1]

      // –û–ø—Ä–µ–¥–µ–ª–∏–º —è–¥—Ä–∞ Sobel: Gx, Gy (3x3)
      const gx = tf.tensor4d([[-1,0,1],[-2,0,2],[-1,0,1]], [3,3,1,1]);
      const gy = tf.tensor4d([[1,2,1],[0,0,0],[-1,-2,-1]], [3,3,1,1]);

      const convX = tf.conv2d(expanded, gx, 1, 'same');
      const convY = tf.conv2d(expanded, gy, 1, 'same');
      const mag = convX.square().add(convY.square()).sqrt().squeeze(); // [H,W]
      return mag;
    });
    // –ü–æ–ª—É—á–∞–µ–º –º–∞—Å—Å–∏–≤ –∑–Ω–∞—á–µ–Ω–∏–π (float) –∏ –ø—Ä–∏–º–µ–Ω–∏–º –ø–æ—Ä–æ–≥
    const magArr = await t.array();
    const H = magArr.length, W = magArr[0].length;
    // –°–æ–∑–¥–∞—ë–º ImageData –¥–ª—è overlay
    overlayCanvas.width = W; overlayCanvas.height = H;
    overlayCanvas.style.width = canvas.width + 'px'; overlayCanvas.style.height = canvas.height + 'px';
    const ctx = overlayCanvas.getContext('2d'); const imgData = ctx.createImageData(W, H);
    const threshold = 60; // –ø–æ—Ä–æ–≥ ‚Äî –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å
    let count = 0;
    for(let y=0;y<H;y++){
      for(let x=0;x<W;x++){
        const v = magArr[y][x];
        const idx = (y*W + x)*4;
        if(v > threshold){ // –æ—Ç–º–µ—á–∞–µ–º –∫–æ–Ω—Ç—É—Ä –±–µ–ª—ã–º
          imgData.data[idx] = 255; imgData.data[idx+1] = 255; imgData.data[idx+2] = 255; imgData.data[idx+3] = 255; count++;
        } else { imgData.data[idx] = 0; imgData.data[idx+1] = 0; imgData.data[idx+2] = 0; imgData.data[idx+3] = 0; }
      }
    }
    ctx.putImageData(imgData, 0, 0);
    logMessage(`Sobel: –æ—á–µ—Ä—á–µ–Ω–Ω—ã—Ö –ø–∏–∫—Å–µ–ª–µ–π = ${count} (–ø–æ—Ä–æ–≥=${threshold})`);
    // –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º —Ç–µ–Ω–∑–æ—Ä
    t.dispose();
    return {method:'sobel', count};
  }

  if(modelName.toLowerCase().includes('mobilenet')){
    logMessage('AI: MobileNet (tfjs) ‚Äî –∑–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏ (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è)');
    // –∑–∞–≥—Ä—É–∂–∞–µ–º mobilenet –µ—Å–ª–∏ –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
    if(!state.modelInstances.mobilenet){
      state.modelInstances.mobilenet = await mobilenet.load();
      logMessage('MobileNet –∑–∞–≥—Ä—É–∂–µ–Ω');
    }
    const model = state.modelInstances.mobilenet;
    // –º–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å canvas –ø—Ä—è–º–æ –≤ model.classify
    const predictions = await model.classify(canvas);
    logMessage('MobileNet predictions: ' + JSON.stringify(predictions));
    return {method:'mobilenet', predictions};
  }

  // –î–ª—è –ø—Ä–æ—á–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –Ω–∞–∑–≤–∞–Ω–∏–π ‚Äî –ø–æ–∫–∞ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è
  logMessage('AI: –º–æ–¥–µ–ª—å –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏, –≤—ã–±–µ—Ä–∏—Ç–µ Sobel –∏–ª–∏ MobileNet');
  return null;
}

// –£—Ç–∏–ª–∏—Ç—ã: –ø—Ä–æ—Å—Ç–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–∂–∏–¥–∞–Ω–∏—è
function wait(ms){ return new Promise(r=>setTimeout(r, ms)); }

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: —Å–æ–∑–¥–∞—ë–º –ø—É—Å—Ç—É—é –≥–∞–ª–µ—Ä–µ—é –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
(function init(){ state.galleries.push({ id:'g_default', name:'Main Gallery', items:[] }); renderGalleries(); logMessage('OctoCore –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω'); })();

</script>
</body>
</html>
