<!DOCTYPE html>
<html lang="ru">
<head>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/cobalt.min.css" />
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OctoCore Dashboard</title>
<style>
  /* Базовые стили: левый фиксированный сайдбар и основная область */
  body { margin: 0; font-family: Arial, sans-serif; display: flex; height: 100vh; background:#071423; color:#e6eef6 }
  #sidebar { width: 320px; background: #0f1724; color: white; padding: 12px; overflow-y: auto; position: fixed; left: 0; top: 0; bottom: 0; box-shadow: 6px 0 20px rgba(0,0,0,.6); }
  #sidebar h3{margin-top:0}
  #main { flex: 1; margin-left: 320px; display: flex; flex-direction: column; min-height:100vh }
  header { background: linear-gradient(90deg,#07182a,#0b2633); color: white; padding: 12px; display: flex; justify-content: space-between; align-items: center; border-bottom:1px solid rgba(255,255,255,0.02) }

  /* Навигация вкладок */
  nav { display: flex; background: #07202a; color: white }
  nav button { flex: 1; padding: 10px; background: none; border: none; color: #bfeef9; cursor: pointer }
  nav button.active { background: linear-gradient(90deg,#05343a,#024b4f); color: white }

  .content { padding: 12px; overflow:auto }

  /* Область камер: ограничена шириной viewport */
  .camera-container { display:flex; flex-wrap:wrap; gap:12px; max-width:100vw }

  /* Карточка камеры: видео + кнопки (snapshot bottom-left, ai bottom-right, delete top-right) */
  .camera { position: relative; width: 320px; background: #061219; border-radius:8px; padding:6px; box-shadow: 0 6px 24px rgba(2,6,23,.6); }
  .camera video { width:100%; height: auto; border-radius:6px; background:black; display:block }
  .camera .btn-top-right { position:absolute; top:10px; right:10px; background:#ef4444; color:white; border:none; padding:6px 8px; border-radius:6px; cursor:pointer }
  .camera .btn-bottom-right { position:absolute; bottom:10px; right:10px; background:#06b6d4; color:#012; border:none; padding:6px 8px; border-radius:6px; cursor:pointer }
  .camera .btn-bottom-left { position:absolute; bottom:10px; left:10px; background:linear-gradient(90deg,#ffd166,#ff7a00); color:#012; border:none; padding:6px 8px; border-radius:6px; cursor:pointer; display:flex; gap:6px; align-items:center }

  /* Выпадающий список моделей рядом с кнопкой ИИ */
  .model-select { position:absolute; bottom:46px; right:10px; display:none; flex-direction:column; gap:6px; }
  .model-select select{padding:6px;border-radius:6px;background:#052028;border:1px solid rgba(255,255,255,0.04);color:#e6eef6}
  .model-select button{padding:6px;border-radius:6px;background:#06b6d4;color:#012;border:none}

  /* Галереи: каждая галерея - блок с горизонтальным таймлайном (scroll-x) */
  .gallery-block{ background:#071827; padding:10px; border-radius:8px; margin-bottom:12px }
  .timeline { display:flex; gap:8px; overflow:auto; padding:6px }
  .timeline img{ height:96px; border-radius:6px }

  /* Логи как в консоли: строчка под строчкой */
  #logConsole { background:#000; color:#0f0; padding:8px; font-family: monospace; height:220px; overflow:auto; border-radius:6px; border:1px solid rgba(255,255,255,0.02) }

  /* Мобильная адаптация */
  @media(max-width:900px){ #sidebar{ position:relative; width:100%; height:auto } #main{ margin-left:0 } }
</style>
</head>
<body>
  <!-- Сайдбар слева: глобальные модели, настройки, действия -->
  <div id="sidebar">
    <h3>Меню OctoCore</h3>
    <div style="margin-bottom:8px">Камеры · AI · Хранение</div>

    <button onclick="addCamera()" style="width:100%;margin-bottom:8px;padding:8px;border-radius:6px;background:#06b6d4;color:#012;border:none;cursor:pointer">Добавить веб-камеру</button>

    <h4 style="margin:8px 0 6px">IP-камера</h4>
    <input id="ipCamUrl" placeholder="URL IP камеры" style="width:100%;padding:8px;margin-bottom:6px;border-radius:6px;background:#02171a;color:#e6eef6;border:1px solid rgba(255,255,255,0.03)" />
    <div style="display:flex;gap:6px;margin-bottom:8px">
      <input id="ipCamLogin" placeholder="Логин" style="flex:1;padding:8px;border-radius:6px;background:#02171a;color:#e6eef6;border:1px solid rgba(255,255,255,0.03)" />
      <input id="ipCamPass" placeholder="Пароль" type="password" style="width:120px;padding:8px;border-radius:6px;background:#02171a;color:#e6eef6;border:1px solid rgba(255,255,255,0.03)" />
    </div>
    <button onclick="addIPCamera()" style="width:100%;padding:8px;border-radius:6px;background:#0ea5a0;border:none;color:#012;cursor:pointer">Добавить IP-камеру</button>

    <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0" />

    <h4 style="margin:6px 0">Глобальные модели</h4>
    <div style="display:flex;gap:6px;margin-bottom:8px">
      <select id="globalModel" style="flex:1;padding:8px;border-radius:6px;background:#02171a;color:#e6eef6;border:1px solid rgba(255,255,255,0.03)"></select>
      <button onclick="uploadModel()" style="padding:8px;border-radius:6px;background:#06b6d4;border:none;color:#012">Загрузить</button>
    </div>
    <div style="font-size:.85rem;color:#94a3b8;margin-bottom:12px">Выберите модель — она станет доступна в каждой карточке камеры для анализа одного снимка или всего таймлапса.</div>

    <button onclick="restartCameras()" style="width:100%;margin-bottom:8px;padding:8px;border-radius:6px;background:#3b82f6;border:none;color:white;cursor:pointer">Перезапустить все</button>
    <button onclick="scanNetwork()" style="width:100%;margin-bottom:8px;padding:8px;border-radius:6px;background:#60a5fa;border:none;color:white;cursor:pointer">Сканировать сеть</button>

    <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0" />

    <button onclick="showIPFSRecords()" style="width:100%;padding:8px;border-radius:6px;background:#0ea5a0;border:none;color:#012;cursor:pointer">Показать сохранённые CID</button>

    <div style="margin-top:12px">
      <div style="font-size:.9rem;color:#9ca3af;margin-bottom:6px">Логи (консоль)</div>
      <div id="logConsole"></div>
    </div>
  </div>

  <!-- Основная область справа -->
  <div id="main">
    <header>
      <div>
        <strong>OctoCore</strong>
        <div style="font-size:.85rem;color:#94a3b8">Веб дашборд — камеры, AI-анализ, IPFS</div>
      </div>
      <div>
        <button onclick="toggleSidebar()" style="padding:8px;border-radius:6px;background:#05323a;border:none;color:#e6eef6;cursor:pointer">Свернуть меню</button>
      </div>
    </header>

    <nav>
      <button id="tabBtnCams" class="active" onclick="showTab('cams')">Камеры</button>
      <button id="tabBtnGalleries" onclick="showTab('galleries')">Галереи</button>
      <button id="tabBtnTl" onclick="showTab('timelapses')">Таймлапсы</button>
    </nav>

    <div class="content">
      <section id="cams" class="tab active">
        <h3>Камеры</h3>
        <div class="camera-container" id="cameraContainer"></div>
      </section>

      <section id="galleries" class="tab" style="display:none">
        <h3>Галереи</h3>
        <div id="galleriesList"></div>
      </section>

      <section id="timelapses" class="tab" style="display:none">
        <h3>Таймлапсы</h3>
        <div id="timelapsesList"></div>
      </section>
    </div>
  </div>

  <!-- Подключаем TensorFlow.js и MobileNet для демонстрации анализа -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.12.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0/dist/mobilenet.min.js"></script>

<script>
/*
  Объяснение изменений:
  - Карточка камеры теперь имеет кнопку "СНИМОК" (иконка фотоаппарата) в левом нижнем углу.
  - Рядом с кнопкой ИИ добавлен выпадающий список моделей; при выборе модели выполняется
    демонстрационный анализ: либо извлечение признаков через MobileNet (класификация),
    либо выделение контуров (Sobel) и подсчёт очерченных пикселей с помощью TensorFlow.js.
  - Результаты анализа и действия логируются в консоль-панель слева (строкой под строкой).
*/

// Состояние приложения
const state = {
  cameras: [], // {id, stream, el, video, overlayCanvas}
  models: ['Sobel (tfjs)', 'MobileNet (tfjs)'],
  modelInstances: {}, // кэш загруженных моделей, напр. mobilenet
  galleries: []
};

// Хелперы
const $ = id => document.getElementById(id);
function logMessage(msg){ const el = $('logConsole'); const time = new Date().toLocaleTimeString(); el.innerHTML += `[${time}] ${msg}<br>`; el.scrollTop = el.scrollHeight; }

// Инициализация списка моделей
function updateModelList(){ const sel = $('globalModel'); sel.innerHTML = state.models.map(m => `<option>${m}</option>`).join(''); }
updateModelList();

// Скрыть/показать сайдбар
let sidebarVisible = true;
function toggleSidebar(){ sidebarVisible = !sidebarVisible; document.getElementById('sidebar').style.display = sidebarVisible ? 'block' : 'none'; }

// Вкладки
function showTab(id){ ['tabBtnCams','tabBtnGalleries','tabBtnTl'].forEach(b=>$(b).classList.remove('active')); ['cams','galleries','timelapses'].forEach(s=>$(s).style.display='none');
  if(id==='cams'){ $('tabBtnCams').classList.add('active'); $('cams').style.display='block' }
  if(id==='galleries'){ $('tabBtnGalleries').classList.add('active'); $('galleries').style.display='block' }
  if(id==='timelapses'){ $('tabBtnTl').classList.add('active'); $('timelapses').style.display='block' }
}

// Добавление веб-камеры
async function addCamera(){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
    createCameraCard(stream);
    logMessage('Веб-камера добавлена');
  }catch(e){ logMessage('Ошибка доступа к камере: ' + (e.message || e)); alert('Ошибка доступа к камере: ' + (e.message || e)); }
}

function createCameraCard(stream){ const id='cam_'+Math.random().toString(36).slice(2,9); const el=document.createElement('div'); el.className='camera'; el.dataset.camId=id; const video=document.createElement('video'); video.autoplay=true; video.playsInline=true; video.muted=true; video.srcObject=stream; const overlay=document.createElement('canvas'); overlay.style.position='absolute'; overlay.style.left='6px'; overlay.style.top='6px'; overlay.style.pointerEvents='none'; overlay.style.borderRadius='8px'; const controls=document.createElement('div'); controls.className='cam-controls'; const btnAI=document.createElement('button'); btnAI.innerHTML='<i class="fa-solid fa-robot"></i>'; btnAI.title='ИИ'; const btnRecord=document.createElement('button'); btnRecord.innerHTML='<i class="fa-solid fa-circle"></i>'; btnRecord.title='Запись'; const btnDel=document.createElement('button'); btnDel.innerHTML='<i class="fa-solid fa-trash"></i>'; btnDel.title='Удалить';
  // При удалении гарантируем остановку всех активностей: интервалы, запись и медиа треков
  btnDel.onclick=()=>{
    const cam = state.cameras.find(c=>c.id===id);
    if(cam){ if(cam._intervalHandle) clearInterval(cam._intervalHandle); cam._intervalHandle = null; if(cam.recorder && cam.recording){ try{ cam.recorder.stop(); }catch(e){} cam.recording=false; } try{ if(cam.stream) cam.stream.getTracks().forEach(t=>t.stop()); }catch(e){}
    }
    el.remove(); state.cameras = state.cameras.filter(c=>c.id!==id); log('Камера удалена: '+id);
  };
  btnAI.onclick=()=>{ modelBox.style.display = modelBox.style.display==='block'?'none':'block'; };
  btnRecord.onclick=()=>toggleRecording(id);
  controls.appendChild(btnAI); controls.appendChild(btnRecord); controls.appendChild(btnDel);
  const bottom=document.createElement('div'); bottom.className='cam-bottom'; const snap=document.createElement('button'); snap.className='btn'; snap.innerHTML='<i class="fa-solid fa-camera"></i>'; snap.title='Снимок';
  snap.onclick=async()=>{
    // при нажатии "Снимок" применяем значение из поля интервала и (пере)запускаем интервальную съёмку
    const cam = state.cameras.find(c=>c.id===id);
    const intInput = bottom.querySelector('input[type=number]'); const val = parseInt(intInput.value,10) || 5;
    if(cam){ cam.intervalMs = val*1000; startIntervalCapture(id); }
    try{ const blob = await captureImageFromVideo(video); addSnapshotToGallery(blob); log('Снимок сделан: '+id+' (интервал '+val+'s)'); }catch(e){ log('Ошибка снимка: '+e.message); }
  };
  const interval=document.createElement('input'); interval.type='number'; interval.min=1; interval.value=5; interval.title='Интервал (сек)'; interval.onchange=()=>{ const cam = state.cameras.find(c=>c.id===id); if(cam) cam.intervalMs = parseInt(interval.value,10)*1000; };
  bottom.appendChild(snap); bottom.appendChild(interval);
  const modelBox=document.createElement('div'); modelBox.className='model-select'; modelBox.style.display='none'; const select=document.createElement('select'); select.innerHTML = state.models.map(m=>`<option>${m}</option>`).join(''); const run=document.createElement('button'); run.textContent='Run'; run.onclick=async()=>{ const modelName=select.value; log('AI run '+modelName+' on '+id); const canvas=await captureCanvasFromVideo(video); await runAIAnalysisOnCanvas(canvas,modelName,overlay); };
  const toggleOverlayBtn=document.createElement('button'); toggleOverlayBtn.textContent='Toggle'; toggleOverlayBtn.onclick=()=>{ overlay.style.display = overlay.style.display==='none'?'block':'none'; };
  modelBox.appendChild(select); modelBox.appendChild(run); modelBox.appendChild(toggleOverlayBtn);
  el.appendChild(video); el.appendChild(overlay); el.appendChild(controls); el.appendChild(bottom); el.appendChild(modelBox); $('cameraContainer').appendChild(el); state.cameras.push({ id, type:'web', stream, el, video, overlay, intervalMs:5000, recorder:null, recording:false, _intervalHandle:null }); video.addEventListener('loadedmetadata',()=>{ overlay.width=video.videoWidth||video.clientWidth; overlay.height=video.videoHeight||video.clientHeight; overlay.style.width=video.clientWidth+'px'; overlay.style.height=video.clientHeight+'px'; overlay.style.display='none'; }); startIntervalCapture(id);
}\

// Функция захвата кадра в Blob
function captureImageFromVideo(videoEl, mime='image/png', quality=0.92){
  return new Promise((resolve,reject)=>{
    try{
      const w = videoEl.videoWidth || videoEl.clientWidth || 640;
      const h = videoEl.videoHeight || videoEl.clientHeight || 480;
      const canvas = document.createElement('canvas'); canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d'); ctx.drawImage(videoEl, 0, 0, w, h);
      canvas.toBlob(blob => resolve(blob), mime, quality);
    }catch(e){ reject(e); }
  });
}

// Возвращает canvas с изображением текущего кадра
function captureCanvasFromVideo(videoEl){
  return new Promise((resolve,reject)=>{
    try{
      const w = videoEl.videoWidth || videoEl.clientWidth || 640;
      const h = videoEl.videoHeight || videoEl.clientHeight || 480;
      const canvas = document.createElement('canvas'); canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d'); ctx.drawImage(videoEl, 0, 0, w, h);
      resolve(canvas);
    }catch(e){ reject(e); }
  });
}

// Добавление снимка в простую галерею (добавляем миниатюру в раздел Галереи)
function addSnapshotToGallery(blob){
  const url = URL.createObjectURL(blob);
  // Если нет галереи — создаём простую
  if(state.galleries.length === 0){ state.galleries.push({ id:'g_default', name:'Main Gallery', items:[] }); }
  const g = state.galleries[0];
  const item = { id: 'it_' + Math.random().toString(36).slice(2,8), src: url, blob };
  g.items.push(item);
  renderGalleries();
}

function renderGalleries(){
  const container = $('galleriesList'); container.innerHTML = '';
  state.galleries.forEach(g =>{
    const block = document.createElement('div'); block.className='gallery-block';
    const title = document.createElement('div'); title.innerHTML = `<strong>${g.name}</strong> <span style=\"color:#9ca3af;margin-left:8px\">(${g.items.length} items)</span>`;
    const timeline = document.createElement('div'); timeline.className='timeline';
    g.items.forEach(it=>{
      const img = document.createElement('img'); img.src = it.src; timeline.appendChild(img);
    });
    block.appendChild(title); block.appendChild(timeline); container.appendChild(block);
  });
}

// Перезапуск всех камер: останавливаем и перезапускаем (в браузере сложность с deviceId; мы попытаемся запросить снова)
async function restartCameras(){
  logMessage('Перезапуск всех камер...');
  // Остановим старые
  state.cameras.forEach(c=>{ try{ c.stream.getTracks().forEach(t=>t.stop()); }catch(e){} if(c.el && c.el.parentNode) c.el.parentNode.removeChild(c.el); });
  state.cameras = [];
  // Попробуем открыть одну камеру заново
  try{ await addCamera(); logMessage('Перезапуск завершён'); }catch(e){ logMessage('Ошибка при перезапуске: '+e.message); }
}

function scanNetwork(){ logMessage('Сканирование сети (демо) — для реального сканирования используйте серверный прокси'); }
function addIPCamera(){ const url = $('ipCamUrl').value.trim(); if(!url){ alert('Введите URL'); return; } // вставим как картинку
  const id = 'ip_' + Math.random().toString(36).slice(2,8);
  const el = document.createElement('div'); el.className='camera'; el.dataset.camId = id;
  const img = document.createElement('img'); img.src = url; img.style.width='100%'; img.style.borderRadius='6px';
  const btnDel = document.createElement('button'); btnDel.textContent='Удалить'; btnDel.className='btn-top-right'; btnDel.onclick=()=>{ el.remove(); logMessage('IP камера удалена: '+id); };
  el.appendChild(img); el.appendChild(btnDel); $('cameraContainer').appendChild(el); logMessage('IP камера добавлена: '+url); }

function uploadModel(){ const name = prompt('Введите название модели (Sobel (tfjs) или MobileNet (tfjs) рекомендуются)'); if(!name) return; state.models.push(name); updateModelList(); // обновим селекты в каждую карточку
  document.querySelectorAll('.model-select select').forEach(s=>{ s.innerHTML = state.models.map(m=>`<option>${m}</option>`).join(''); }); logMessage('Модель добавлена: '+name); }

// Показываем сохранённые CID (localStorage) — демонстрация
function showIPFSRecords(){ const raw = localStorage.getItem('octocore_ipfs_records') || '[]'; const w = window.open(); w.document.body.style.background='#071423'; w.document.body.style.color='#e6eef6'; const pre = w.document.createElement('pre'); pre.textContent = raw; w.document.body.appendChild(pre); }

// ===================== AI: реализация Sobel и MobileNet через tfjs =====================

async function runAIAnalysisOnCanvas(canvas, modelName, overlayCanvas){
  // modelName: строка, overlayCanvas: canvas (overlay) элемент для отрисовки результата
  if(modelName.includes('Sobel')){
    // Используем tfjs для свёртки Sobel и подсчёта очерченных пикселей
    logMessage('AI: Sobel edge detection (tfjs) — старт');
    await tf.ready();
    const t = tf.tidy(()=>{
      // Создадим тензор [1, H, W, 1] из изображения в градациях серого
      let img = tf.browser.fromPixels(canvas).mean(2).toFloat(); // [H,W]
      const expanded = img.expandDims(0).expandDims(-1); // [1,H,W,1]

      // Определим ядра Sobel: Gx, Gy (3x3)
      const gx = tf.tensor4d([[-1,0,1],[-2,0,2],[-1,0,1]], [3,3,1,1]);
      const gy = tf.tensor4d([[1,2,1],[0,0,0],[-1,-2,-1]], [3,3,1,1]);

      const convX = tf.conv2d(expanded, gx, 1, 'same');
      const convY = tf.conv2d(expanded, gy, 1, 'same');
      const mag = convX.square().add(convY.square()).sqrt().squeeze(); // [H,W]
      return mag;
    });
    // Получаем массив значений (float) и применим порог
    const magArr = await t.array();
    const H = magArr.length, W = magArr[0].length;
    // Создаём ImageData для overlay
    overlayCanvas.width = W; overlayCanvas.height = H;
    overlayCanvas.style.width = canvas.width + 'px'; overlayCanvas.style.height = canvas.height + 'px';
    const ctx = overlayCanvas.getContext('2d'); const imgData = ctx.createImageData(W, H);
    const threshold = 60; // порог — можно настроить
    let count = 0;
    for(let y=0;y<H;y++){
      for(let x=0;x<W;x++){
        const v = magArr[y][x];
        const idx = (y*W + x)*4;
        if(v > threshold){ // отмечаем контур белым
          imgData.data[idx] = 255; imgData.data[idx+1] = 255; imgData.data[idx+2] = 255; imgData.data[idx+3] = 255; count++;
        } else { imgData.data[idx] = 0; imgData.data[idx+1] = 0; imgData.data[idx+2] = 0; imgData.data[idx+3] = 0; }
      }
    }
    ctx.putImageData(imgData, 0, 0);
    logMessage(`Sobel: очерченных пикселей = ${count} (порог=${threshold})`);
    // освобождаем тензор
    t.dispose();
    return {method:'sobel', count};
  }

  if(modelName.toLowerCase().includes('mobilenet')){
    logMessage('AI: MobileNet (tfjs) — загрузка модели (если требуется)');
    // загружаем mobilenet если ещё не загружен
    if(!state.modelInstances.mobilenet){
      state.modelInstances.mobilenet = await mobilenet.load();
      logMessage('MobileNet загружен');
    }
    const model = state.modelInstances.mobilenet;
    // можно передать canvas прямо в model.classify
    const predictions = await model.classify(canvas);
    logMessage('MobileNet predictions: ' + JSON.stringify(predictions));
    return {method:'mobilenet', predictions};
  }

  // Для прочих пользовательских названий — пока демонстрация
  logMessage('AI: модель не поддерживается для демонстрации, выберите Sobel или MobileNet');
  return null;
}

// Утилиты: простая функция ожидания
function wait(ms){ return new Promise(r=>setTimeout(r, ms)); }

// Инициализация: создаём пустую галерею по умолчанию
(function init(){ state.galleries.push({ id:'g_default', name:'Main Gallery', items:[] }); renderGalleries(); logMessage('OctoCore инициализирован'); })();

</script>
</body>
</html>
