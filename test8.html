<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>OctoCore — Web Dashboard (Updated)</title>

<!-- Иконки: Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- CodeMirror + тема Cobalt для IDE -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/cobalt.min.css" />

<style>
  /* --- Общие стили --- */
  :root{ --bg:#071423; --panel:#071827; --accent:#06b6d4; --muted:#94a3b8 }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:#e6eef6}

  /* Левое фиксированное меню */
  #sidebar{position:fixed;left:0;top:0;bottom:0;width:340px;padding:16px;background:linear-gradient(180deg,#071826,#04121a);overflow:auto;border-right:1px solid rgba(255,255,255,0.03)}
  #main{margin-left:340px;padding:12px}
  h3,h4{margin:6px 0}
  .block{background:rgba(255,255,255,0.02);padding:10px;border-radius:10px;margin-bottom:12px}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:8px;border:none;cursor:pointer}
  .btn.primary{background:var(--accent);color:#012}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}

  /* Spinner */
  .spinner{width:16px;height:16px;border:2px solid rgba(255,255,255,0.2);border-top-color:white;border-radius:50%;animation:spin .8s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* Навигация вкладок */
  nav{display:flex;gap:8px;margin-bottom:12px}
  nav button{padding:8px 12px;border-radius:8px;border:none;background:transparent;color:var(--muted);cursor:pointer}
  nav button.active{background:linear-gradient(90deg,#05343a,#024b4f);color:white}

  /* Камеры */
  .camera-container{display:flex;flex-wrap:wrap;gap:12px;max-width:100vw}
  .camera{position:relative;width:320px;background:#061219;border-radius:10px;padding:6px;box-shadow:0 6px 24px rgba(0,0,0,0.6)}
  .camera video,.camera img{width:100%;border-radius:8px;display:block}
  .cam-controls{position:absolute;right:8px;top:8px;display:flex;flex-direction:column;gap:6px}
  .cam-controls button{background:rgba(0,0,0,0.45);border:1px solid rgba(255,255,255,0.04);color:#e6eef6;padding:6px;border-radius:6px;cursor:pointer;width:36px;height:36px;display:flex;align-items:center;justify-content:center}
  .cam-bottom{position:absolute;left:8px;bottom:8px;display:flex;gap:6px;align-items:center}
  .cam-bottom input[type=number]{width:72px;padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#e6eef6}

  /* model select small */
  .model-select{position:absolute;right:8px;bottom:56px;background:#02171a;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);display:none}
  .model-select select{padding:6px;border-radius:6px;background:transparent;color:#e6eef6;border:1px solid rgba(255,255,255,0.04)}
  .model-select button{margin-top:6px;padding:6px;border-radius:6px;background:var(--accent);border:none;color:#012}

  /* Галереи и таймлайны */
  .gallery-block{background:#071827;padding:10px;border-radius:8px;margin-bottom:12px}
  .gallery-controls{display:flex;gap:8px;align-items:center;margin-bottom:6px}
  .timeline{display:flex;gap:8px;overflow:auto;padding:6px}
  .thumb{position:relative}
  .thumb img{height:96px;border-radius:6px}
  .thumb input[type=checkbox]{position:absolute;left:6px;top:6px}

  /* CID modal */
  .modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#071423;padding:16px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);z-index:999;width:820px;max-width:95%;display:none}
  .modal h4{margin-top:0}
  .modal .row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
  .modal .cid-list{max-height:300px;overflow:auto;background:#03141a;padding:8px;border-radius:6px}
  .modal .cid-item{display:flex;justify-content:space-between;align-items:center;padding:6px;border-bottom:1px solid rgba(255,255,255,0.02)}

  /* Logs + IDE */
  #logConsole{background:#000;color:#0f0;padding:8px;font-family:monospace;height:160px;overflow:auto;border-radius:6px;border:1px solid rgba(255,255,255,0.02);white-space:pre-wrap}
  .ide{margin-top:8px}
  .ide .controls{display:flex;gap:8px;margin-bottom:6px}
  .hidden{display:none}

  /* responsive */
  @media(max-width:900px){#sidebar{position:relative;width:100%;height:auto}#main{margin-left:0}}
</style>
</head>
<body>

<!-- Сайдбар -->
<div id="sidebar">
  <h3>OctoCore</h3>
  <div style="font-size:.9rem;color:var(--muted);margin-bottom:8px">Веб дашборд • камеры • AI • IPFS</div>

  <!-- Сканировать / Перезапустить -->
  <div class="block">
    <div style="display:flex;gap:8px;align-items:center">
      <button id="scanBtn" class="btn primary" onclick="handleScanClick()"><i class="fa-solid fa-magnifying-glass"></i> Сканировать</button>
      <div style="position:relative">
        <button id="scanMenuBtn" class="btn ghost" onclick="toggleScanMenu()"><i class="fa-solid fa-ellipsis"></i></button>
        <div id="scanMenu" style="position:absolute;right:0;top:36px;background:#02171a;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);display:none">
          <button class="btn small" onclick="handleRestartClick()"><i class="fa-solid fa-arrows-rotate"></i> Перезапустить</button>
        </div>
      </div>
    </div>
    <div style="font-size:.85rem;color:var(--muted);margin-top:6px">Сканирование сети и источников (демо)</div>
  </div>

  <!-- Добавить источники -->
  <div class="block">
    <h4>Добавить источник</h4>
    <div style="display:flex;gap:8px;margin-bottom:8px">
      <select id="sourceType" style="flex:1;padding:8px;border-radius:6px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:#e6eef6" onchange="onSourceTypeChange()">
        <option value="web">Web-камера</option>
        <option value="ip">IP-камера</option>
      </select>
      <button class="btn" onclick="onAddSourceClick()"><i class="fa-solid fa-plus"></i></button>
    </div>
    <div id="ipFields" class="hidden">
      <input id="newIpUrl" placeholder="http://192.168.x.x/snapshot.jpg" style="width:100%;padding:8px;border-radius:6px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:#e6eef6;margin-bottom:6px" />
      <div style="display:flex;gap:6px;margin-bottom:6px">
        <input id="newIpLogin" placeholder="Логин" style="flex:1;padding:8px;border-radius:6px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:#e6eef6" />
        <input id="newIpPass" placeholder="Пароль" type="password" style="width:140px;padding:8px;border-radius:6px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:#e6eef6" />
      </div>
      <button class="btn" onclick="addIPPlaceholder()">Добавить IP (заглушка)</button>
    </div>
  </div>

  <!-- Глобальные модели -->
  <div class="block">
    <h4>Глобальные модели</h4>
    <div style="display:flex;gap:8px;margin-bottom:8px">
      <select id="globalModel" style="flex:1;padding:8px;border-radius:6px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:#e6eef6"></select>
      <button class="btn" onclick="uploadModel()"><i class="fa-solid fa-upload"></i> Загрузить</button>
    </div>
    <div style="font-size:.85rem;color:var(--muted)">Модели предзагружаются и доступны в каждой камере.</div>
  </div>

  <!-- CID modal opener + quick actions -->
  <div class="block">
    <button class="btn" onclick="openCIDModal()"><i class="fa-solid fa-database"></i> Сохранённые CID</button>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button class="btn ghost" onclick="scanNetwork()"><i class="fa-solid fa-network-wired"></i> Сканировать</button>
      <button class="btn ghost" onclick="restartCameras()"><i class="fa-solid fa-arrows-rotate"></i> Перезапустить</button>
    </div>
  </div>

  <!-- Логи и IDE -->
  <div class="block">
    <h4>Логи</h4>
    <div id="logConsole"></div>
  </div>

  <div class="block">
    <h4>IDE</h4>
    <div class="ide">
      <div class="controls">
        <select id="ideLang"><option value="js">JavaScript</option><option value="py">Python</option></select>
        <button class="btn" onclick="runIDE()">Запустить</button>
        <button class="btn ghost" onclick="toggleApplyToModels()">Применять к ИИ</button>
      </div>
      <textarea id="ide" style="width:100%;height:180px;background:#02171a;color:#e6eef6;">console.log('OctoCore IDE')</textarea>
      <div style="font-size:.8rem;color:var(--muted);margin-top:6px">Python загрузится <!--через Pyodide--> при первом запуске.</div>
    </div>
  </div>
</div>

<!-- Main -->
<div id="main">
  <header>
    <div>
      <strong>OctoCore</strong>
      <div style="font-size:.85rem;color:#94a3b8">Мультикамеры, AI-анализ, IPFS</div>
    </div>
    <div>
      <button class="btn ghost" onclick="toggleSidebar()">Свернуть меню</button>
    </div>
  </header>

  <nav>
    <button id="tabBtnCams" class="active" onclick="showTab('cams')">Камеры</button>
    <button id="tabBtnGalleries" onclick="showTab('galleries')">Галереи</button>
    <button id="tabBtnTl" onclick="showTab('timelapses')">Таймлапсы</button>
  </nav>

  <div class="content">
    <section id="cams" class="tab active">
      <h3>Камеры</h3>
      <div class="camera-container" id="cameraContainer"></div>
    </section>

    <section id="galleries" class="tab" style="display:none">
      <h3>Галереи</h3>
      <div class="gallery-controls">
        <input id="newGalleryName" placeholder="Название галереи" style="padding:8px;border-radius:6px;background:#02171a;border:1px solid rgba(255,255,255,0.04);color:#e6eef6" />
        <button class="btn" onclick="createGallery()">Создать галерею</button>
        <button class="btn ghost" onclick="selectAllFrames(true)">Выбрать все</button>
        <button class="btn ghost" onclick="selectAllFrames(false)">Снять выбор</button>
        <button class="btn ghost" onclick="deleteSelectedFrames()"><i class="fa-solid fa-trash"></i> Удалить выбранные</button>
      </div>
      <div id="galleriesList"></div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn" onclick="sendSelectedToIPFS()">Отправить выбранные в IPFS</button>
        <button class="btn" onclick="createTimelapseFromSelected()">Создать таймлапс</button>
        <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
          <input id="fetchCidInput" placeholder="CID для получения" style="padding:8px;border-radius:6px;background:#02171a;border:1px solid rgba(255,255,255,0.04);color:#e6eef6" />
          <button class="btn ghost" onclick="fetchFromIPFS()">Получить из IPFS</button>
        </div>
      </div>
    </section>

    <section id="timelapses" class="tab" style="display:none">
      <h3>Таймлапсы</h3>
      <div id="timelapsesList"></div>
    </section>
  </div>
</div>

<!-- CID modal -->
<div id="cidModal" class="modal">
  <h4>Сохранённые CID (локально)</h4>
  <div class="row">
    <input id="newCidInput" placeholder="CID" style="flex:1;padding:8px;border-radius:6px;background:#02171a;border:1px solid rgba(255,255,255,0.04);color:#e6eef6" />
    <input id="newCidNote" placeholder="Метка/комментарий" style="width:220px;padding:8px;border-radius:6px;background:#02171a;border:1px solid rgba(255,255,255,0.04);color:#e6eef6" />
    <button class="btn" onclick="addCIDManually()">Добавить</button>
    <button class="btn ghost" onclick="closeCIDModal()">Закрыть</button>
  </div>
  <div class="cid-list" id="cidList"></div>
</div>

<!-- Библиотеки: tfjs, mobilenet, codemirror (скрипты) -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.12.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0/dist/mobilenet.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/python/python.min.js"></script>

<script>
/*
  OctoCore — полностью обновлённый фронтенд (WEB) в одном HTML файле.
  Комментарии на русском языке внутри кода, чтобы ты мог быстро понять и менять логику.

  Важные особенности:
  - Левое фиксированное меню (включая загрузку/выбор моделей)
  - Камеры: web и ip (заглушки), кнопки компактными иконками
  - При удалении камеры полностью останавливается её активность (интервалы, запись, треки)
  - "Снимок" применяет текущее значение интервала и (пере)запускает интервальную съёмку
  - Галереи: чекбоксы, удаление выделенных кадров, отправка в IPFS (демо), загрузка из IPFS
  - Таймлапсы: создаются из выбранных кадров и появляются во вкладке Таймлапсы
  - Код для AI-демо: Sobel через tfjs и MobileNet через tfjs (предзагрузка)
  - IDE (CodeMirror) с темой Cobalt; Python через Pyodide загружается по требованию
*/

// --- Простые хранилища локально ---
const CID_KEY = 'octocore_cid_records_v1';
function loadCIDRecords(){ try{ return JSON.parse(localStorage.getItem(CID_KEY)||'[]'); }catch(e){return[]} }
function saveCIDRecords(arr){ localStorage.setItem(CID_KEY, JSON.stringify(arr)); }

// Состояние приложения
const state = {
  cameras: [], // {id,type,stream,el,video,overlay,intervalMs,recorder,recording,_intervalHandle}
  galleries: [], // [{id,name,items:[{id,src,blob,cid}]}]
  models: ['Sobel (tfjs)','MobileNet (tfjs)'],
  modelInstances: {},
  timelapses: [],
  pyodide: null,
  applyIDEToModels: false
};

// Утилиты
const $ = id => document.getElementById(id);
function log(msg){ const el=$('logConsole'); const ts = new Date().toLocaleTimeString(); el.innerHTML += `[${ts}] ${msg}<br>`; el.scrollTop = el.scrollHeight; }

// Инициализация модели mobileNet заранее
(async function preload(){ try{ log('Загрузка MobileNet...'); state.modelInstances.mobilenet = await mobilenet.load(); log('MobileNet загружен'); }catch(e){ log('Ошибка загрузки MobileNet: '+e.message); } })();

// ========== SCAN / RESTART UI ===========
// --- Управление вкладками и сайдбаром ---
let sidebarVisible = true; // флаг видимости сайдбара

/**
 * showTab(id)
 * Переключает видимые секции: 'cams', 'galleries', 'timelapses'
 * Также обновляет класс active у кнопок навигации.
 */
function showTab(id){
  // Список всех вкладок
  const tabs = ['cams','galleries','timelapses'];
  // Скрываем все вкладки, показываем выбранную
  tabs.forEach(t=>{ const el = $(t); if(el) el.style.display = (t===id)?'block':'none'; });
  // Убираем active у всех кнопок и ставим на соответствующую
  document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
  const map = { cams: 'tabBtnCams', galleries: 'tabBtnGalleries', timelapses: 'tabBtnTl' };
  const btnId = map[id]; if(btnId && $(btnId)) $(btnId).classList.add('active');
}

/**
 * toggleSidebar()
 * Скрывает или показывает левое меню и корректирует отступ основной области.
 */
function toggleSidebar(){
  const sb = $('sidebar'); const main = $('main'); if(!sb || !main) return;
  sidebarVisible = !sidebarVisible;
  if(sidebarVisible){ sb.style.display = 'block'; main.style.marginLeft = '340px'; }
  else { sb.style.display = 'none'; main.style.marginLeft = '0'; }
}

// Экспортируем в window чтобы inline onclick/onchange всегда находили функции
window.showTab = showTab; window.toggleSidebar = toggleSidebar;

// оригинальная функция toggleScanMenu (оставлена без изменений)
function toggleScanMenu(){ const el=$('scanMenu'); el.style.display = el.style.display==='none'?'block':'none'; }
async function handleScanClick(){ const btn=$('scanBtn'); const old = btn.innerHTML; btn.innerHTML = '<span class="spinner"></span> Сканирование...'; log('Сканирование (демо) запущено'); await new Promise(r=>setTimeout(r,4000)); btn.innerHTML = old; log('Сканирование завершено (демо)'); }
async function handleRestartClick(){ $('scanMenu').style.display='none'; const btn=$('scanBtn'); const old = btn.innerHTML; btn.innerHTML = '<span class="spinner"></span> Перезапуск...'; log('Перезапуск (демо)'); await new Promise(r=>setTimeout(r,4000)); btn.innerHTML = old; log('Перезапуск завершён'); }

// ========== ADD SOURCES ===========
function onSourceTypeChange(){ const t=$('sourceType').value; $('ipFields').classList.toggle('hidden', t!=='ip'); }
function onAddSourceClick(){ const t=$('sourceType').value; if(t==='web'){ addCamera(); } else { $('ipFields').classList.remove('hidden'); } }

// Добавляем заглушку IP-камеры, но с теми же контролами что и у Web-камеры
function addIPPlaceholder(){ const url = $('newIpUrl').value.trim(); const login = $('newIpLogin').value.trim(); const pass = $('newIpPass').value.trim(); if(!url){ alert('Введите URL'); return; }
  const id = 'cam_ip_' + Math.random().toString(36).slice(2,8);
  const el = document.createElement('div'); el.className='camera'; el.dataset.camId = id;
  const img = document.createElement('img'); img.src = url; img.alt = 'IP placeholder';
  const overlay = document.createElement('canvas'); overlay.style.position='absolute'; overlay.style.left='6px'; overlay.style.top='6px'; overlay.style.pointerEvents='none'; overlay.style.borderRadius='8px';

  // controls: AI, record (disabled for ip placeholder), delete
  const controls = document.createElement('div'); controls.className='cam-controls';
  const btnAI = document.createElement('button'); btnAI.innerHTML='<i class="fa-solid fa-robot"></i>'; btnAI.title='ИИ';
  const btnRecord = document.createElement('button'); btnRecord.innerHTML='<i class="fa-solid fa-circle"></i>'; btnRecord.title='Запись'; btnRecord.disabled = true;
  const btnDel = document.createElement('button'); btnDel.innerHTML='<i class="fa-solid fa-trash"></i>'; btnDel.title='Удалить';
  btnDel.onclick = ()=>{ const cam = state.cameras.find(c=>c.id===id); if(cam){ if(cam._intervalHandle) clearInterval(cam._intervalHandle); if(cam.recorder && cam.recording) cam.recorder.stop(); } el.remove(); state.cameras = state.cameras.filter(c=>c.id!==id); log('IP камера удалена: '+id); };
  controls.appendChild(btnAI); controls.appendChild(btnRecord); controls.appendChild(btnDel);

  // bottom: snapshot + interval
  const bottom = document.createElement('div'); bottom.className='cam-bottom';
  const snap = document.createElement('button'); snap.className='btn'; snap.innerHTML='<i class="fa-solid fa-camera"></i>'; snap.title='Снимок';
  snap.onclick = async ()=>{
    // применяем интервал и пытаемся взять снимок по URL; если не получится — fallback рисуем текущую картинку
    const intInput = bottom.querySelector('input[type=number]'); const val = parseInt(intInput.value,10) || 5;
    const cam = state.cameras.find(c=>c.id===id); if(cam){ cam.intervalMs = val*1000; startIntervalCapture(id); }
    try{ const resp = await fetch(url); if(resp.ok){ const blob = await resp.blob(); addSnapshotToGallery(blob); log('Снимок IP добавлен: '+url); return; } }
    catch(e){ /* ignore fetch error */ }
    // fallback: draw img into canvas
    try{ const c = document.createElement('canvas'); c.width = img.naturalWidth || 320; c.height = img.naturalHeight || 180; const ctx = c.getContext('2d'); ctx.drawImage(img,0,0,c.width,c.height); c.toBlob(b=>{ addSnapshotToGallery(b); log('Снимок (fallback) добавлен из заглушки'); }); }catch(e){ log('Ошибка снятия с IP-заглушки: '+e.message); }
  };
  const interval = document.createElement('input'); interval.type='number'; interval.min=1; interval.value=5; interval.title='Интервал (сек)'; interval.onchange=()=>{ const cam = state.cameras.find(c=>c.id===id); if(cam) cam.intervalMs = parseInt(interval.value,10)*1000; };
  bottom.appendChild(snap); bottom.appendChild(interval);

  // model select for IP placeholder
  const modelBox = document.createElement('div'); modelBox.className='model-select'; modelBox.style.display='none';
  const select = document.createElement('select'); select.innerHTML = state.models.map(m=>`<option>${m}</option>`).join('');
  const runBtn = document.createElement('button'); runBtn.textContent='Run'; runBtn.onclick = async ()=>{ const modelName = select.value; log('AI run '+modelName+' on '+id); try{ const c = document.createElement('canvas'); c.width = img.naturalWidth||img.clientWidth||320; c.height = img.naturalHeight||img.clientHeight||180; const ctx = c.getContext('2d'); ctx.drawImage(img,0,0,c.width,c.height); await runAIAnalysisOnCanvas(c, modelName, overlay); }catch(e){ log('AI error on IP: '+e.message); } };
  modelBox.appendChild(select); modelBox.appendChild(runBtn);

  el.appendChild(img); el.appendChild(overlay); el.appendChild(controls); el.appendChild(bottom); el.appendChild(modelBox);
  $('cameraContainer').appendChild(el);
  state.cameras.push({ id, type:'ip', url, login, pass, el, overlay, intervalMs:5000, recorder:null, recording:false, _intervalHandle:null });
  log('IP placeholder добавлена: '+url);
}

// ========== WEB CAMERA ===========
async function addCamera(){ try{ const stream = await navigator.mediaDevices.getUserMedia({video:true,audio:false}); createWebCameraCard(stream); log('Веб-камера добавлена'); }catch(e){ log('Ошибка доступа к камере: '+(e.message||e)); alert('Ошибка доступа к камере: '+(e.message||e)); } }

function createWebCameraCard(stream){ const id='cam_'+Math.random().toString(36).slice(2,9); const el=document.createElement('div'); el.className='camera'; el.dataset.camId=id; const video=document.createElement('video'); video.autoplay=true; video.playsInline=true; video.muted=true; video.srcObject=stream; const overlay=document.createElement('canvas'); overlay.style.position='absolute'; overlay.style.left='6px'; overlay.style.top='6px'; overlay.style.pointerEvents='none'; overlay.style.borderRadius='8px';
  // controls (compact icons)
  const controls=document.createElement('div'); controls.className='cam-controls';
  const btnAI=document.createElement('button'); btnAI.innerHTML='<i class="fa-solid fa-robot"></i>'; btnAI.title='ИИ';
  const btnRecord=document.createElement('button'); btnRecord.innerHTML='<i class="fa-solid fa-circle"></i>'; btnRecord.title='Запись';
  const btnDel=document.createElement('button'); btnDel.innerHTML='<i class="fa-solid fa-trash"></i>'; btnDel.title='Удалить';

  // удаление камеры — обязательно остановить интервалы, запись и треки
  btnDel.onclick = ()=>{
    const cam = state.cameras.find(c=>c.id===id);
    if(cam){ if(cam._intervalHandle) clearInterval(cam._intervalHandle); cam._intervalHandle = null; if(cam.recorder && cam.recording){ try{ cam.recorder.stop(); }catch(e){} cam.recording=false; } try{ if(cam.stream) cam.stream.getTracks().forEach(t=>t.stop()); }catch(e){}
    }
    el.remove(); state.cameras = state.cameras.filter(c=>c.id!==id); log('Камера удалена: '+id);
  };

  btnAI.onclick = ()=>{ modelBox.style.display = modelBox.style.display==='block'?'none':'block'; };
  btnRecord.onclick = ()=> toggleRecording(id);
  controls.appendChild(btnAI); controls.appendChild(btnRecord); controls.appendChild(btnDel);

  // bottom: snapshot + interval
  const bottom = document.createElement('div'); bottom.className='cam-bottom';
  const snap = document.createElement('button'); snap.className='btn'; snap.innerHTML='<i class="fa-solid fa-camera"></i>'; snap.title='Снимок';
  snap.onclick = async ()=>{
    // при нажатии "Снимок" применяем значение из поля интервала и (пере)запускаем интервальную съёмку
    const cam = state.cameras.find(c=>c.id===id);
    const intInput = bottom.querySelector('input[type=number]'); const val = parseInt(intInput.value,10) || 5;
    if(cam){ cam.intervalMs = val*1000; startIntervalCapture(id); }
    try{ const blob = await captureImageFromVideo(video); addSnapshotToGallery(blob); log('Снимок сделан: '+id+' (интервал '+val+'s)'); }catch(e){ log('Ошибка снимка: '+e.message); }
  };
  const interval = document.createElement('input'); interval.type='number'; interval.min=1; interval.value=5; interval.title='Интервал (сек)'; interval.onchange = ()=>{ const cam=state.cameras.find(c=>c.id===id); if(cam) cam.intervalMs = parseInt(interval.value,10)*1000; };
  bottom.appendChild(snap); bottom.appendChild(interval);

  // model select box
  const modelBox = document.createElement('div'); modelBox.className='model-select'; modelBox.style.display='none';
  const select = document.createElement('select'); select.innerHTML = state.models.map(m=>`<option>${m}</option>`).join('');
  const run = document.createElement('button'); run.textContent='Run'; run.onclick = async ()=>{ const modelName = select.value; log('AI run '+modelName+' on '+id); const canvas = await captureCanvasFromVideo(video); await runAIAnalysisOnCanvas(canvas, modelName, overlay); };
  const toggleOverlayBtn = document.createElement('button'); toggleOverlayBtn.textContent='Toggle'; toggleOverlayBtn.onclick=()=>{ overlay.style.display = overlay.style.display==='none'?'block':'none'; };
  modelBox.appendChild(select); modelBox.appendChild(run); modelBox.appendChild(toggleOverlayBtn);

  el.appendChild(video); el.appendChild(overlay); el.appendChild(controls); el.appendChild(bottom); el.appendChild(modelBox);
  $('cameraContainer').appendChild(el);
  state.cameras.push({ id, type:'web', stream, el, video, overlay, intervalMs:5000, recorder:null, recording:false, _intervalHandle:null });

  // корректируем overlay по метаданным и стартуем интервальную съёмку
  video.addEventListener('loadedmetadata', ()=>{ overlay.width = video.videoWidth || video.clientWidth; overlay.height = video.videoHeight || video.clientHeight; overlay.style.width = video.clientWidth + 'px'; overlay.style.height = video.clientHeight + 'px'; overlay.style.display='none'; });
  startIntervalCapture(id);
}

// Функция запуска интервалов съёмки — учитывает тип камеры
function startIntervalCapture(id){ const cam = state.cameras.find(c=>c.id===id); if(!cam) return; if(cam._intervalHandle) clearInterval(cam._intervalHandle);
  cam._intervalHandle = setInterval(async ()=>{
    if(cam.type === 'web' && cam.video){ try{ const blob = await captureImageFromVideo(cam.video); addSnapshotToGallery(blob); log('Интервальный снимок: '+id); }catch(e){ log('Ошибка интервального снимка: '+e.message); } }
    else if(cam.type === 'ip'){ try{ const resp = await fetch(cam.url); if(resp.ok){ const blob = await resp.blob(); addSnapshotToGallery(blob); log('Интервальный snapshot (IP): '+id); } }catch(e){ /* ignore */ } }
  }, cam.intervalMs);
}

// Запись видео через MediaRecorder
function toggleRecording(id){ const cam = state.cameras.find(c=>c.id===id); if(!cam) return; if(cam.recording){ cam.recorder.stop(); cam.recording=false; log('Запись остановлена: '+id); } else { const stream = cam.stream; if(!stream){ log('Нет стрима для записи'); return; } const recorder = new MediaRecorder(stream,{mimeType:'video/webm;codecs=vp8'}); cam.chunks = []; recorder.ondataavailable = e=>cam.chunks.push(e.data); recorder.onstop = ()=>{ const blob = new Blob(cam.chunks,{type:'video/webm'}); addSnapshotToGallery(blob); log('Видео добавлено в галерею: '+id); }; cam.recorder = recorder; cam.recording = true; recorder.start(); log('Запись запущена: '+id); } }

// ================== GALLERIES ==================
function createGallery(){ const name = $('newGalleryName').value.trim() || ('Gallery ' + (state.galleries.length+1)); const id = 'g_' + Math.random().toString(36).slice(2,8); state.galleries.push({id,name,items:[]}); renderGalleries(); $('newGalleryName').value=''; log('Галерея создана: '+name); }

function addSnapshotToGallery(blob){ if(state.galleries.length===0) createGallery(); const g = state.galleries[0]; const id = 'it_' + Math.random().toString(36).slice(2,8); const url = URL.createObjectURL(blob); g.items.push({id,src:url,blob,cid:null}); renderGalleries(); }

function renderGalleries(){
  // Рендер всех галерей — создаём отдельные элементы для каждой галереи и её таймлайна
  const container = $('galleriesList');
  container.innerHTML = '';
  state.galleries.forEach(g => {
    const block = document.createElement('div');
    block.className = 'gallery-block';

    const header = document.createElement('div');
    header.style.display = 'flex';
    header.style.justifyContent = 'space-between';
    header.innerHTML = `<strong>${g.name}</strong> <span style="color:var(--muted)">${g.items.length} items</span>`;

    const timeline = document.createElement('div');
    timeline.className = 'timeline';

    g.items.forEach(it => {
      const t = document.createElement('div');
      t.className = 'thumb';
      t.style.position = 'relative';

      const img = document.createElement('img');
      img.src = it.src;
      img.alt = it.id;

      // Чекбокс теперь хранит id кадра в data-атрибуте и корректно синхронизируется с state.selectedFrames
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.dataset.itemId = it.id;
      cb.style.position = 'absolute';
      cb.style.left = '6px';
      cb.style.top = '6px';
      // безопасная проверка наличия Set
      cb.checked = !!(state.selectedFrames && typeof state.selectedFrames.has === 'function' && state.selectedFrames.has(it.id));

      // при изменении чекбокса обновляем Set — используем add/delete
      cb.addEventListener('change', () => {
        if(!state.selectedFrames) state.selectedFrames = new Set();
        if(cb.checked) state.selectedFrames.add(it.id);
        else state.selectedFrames.delete(it.id);
      });

      t.appendChild(cb);
      t.appendChild(img);
      timeline.appendChild(t);
    });

    block.appendChild(header);
    block.appendChild(timeline);
    container.appendChild(block);
  });
}

// selectedFrames set utility
state.selectedFrames = new Set();

function selectAllFrames(flag){
  // flag=true -> выбрать все, flag=false -> снять выбор
  if(!state.selectedFrames) state.selectedFrames = new Set();
  if(flag){
    state.galleries.forEach(g => g.items.forEach(it => state.selectedFrames.add(it.id)));
  } else {
    state.selectedFrames.clear();
  }

  // Обновляем существующие чекбоксы в DOM (не обязательно перерендеривать всю галерею)
  const checkboxes = document.querySelectorAll('#galleriesList input[type=checkbox]');
  checkboxes.forEach(cb => {
    const id = cb.dataset.itemId;
    cb.checked = state.selectedFrames.has(id);
  });
}

function deleteSelectedFrames(){ if(state.selectedFrames.size===0){ alert('Нет выделенных кадров'); return; } state.galleries.forEach(g=>{ g.items = g.items.filter(it=> !state.selectedFrames.has(it.id)); }); state.selectedFrames.clear(); renderGalleries(); log('Выбранные кадры удалены'); }

// Отправка выбранных в IPFS (демо через public gateway / helia API)
async function sendSelectedToIPFS(){ const selected = []; state.galleries.forEach(g=>g.items.forEach(it=>{ if(state.selectedFrames.has(it.id)) selected.push(it); })); if(selected.length===0){ alert('Нет выделенных кадров'); return; } log('Отправка '+selected.length+' элементов в IPFS'); for(const it of selected){ try{ let blob = it.blob; if(!blob){ const resp = await fetch(it.src); blob = await resp.blob(); } const cid = await uploadToIPFS(blob); it.cid = cid; saveCIDRecords(loadCIDRecords().concat([{cid,note:'uploaded',ts:Date.now()}])); log('Загружен в IPFS: '+cid); }catch(e){ log('Ошибка загрузки: '+e.message); } } renderGalleries(); }

// Создание таймлапса из выбранных кадров и добавление в state.timelapses
async function createTimelapseFromSelected(){ const selected=[]; state.galleries.forEach(g=>g.items.forEach(it=>{ if(state.selectedFrames.has(it.id)) selected.push(it); })); if(selected.length<2){ alert('Нужно минимум 2 кадра'); return; } log('Создание таймлапса из '+selected.length+' кадров'); const imgs=[]; for(const it of selected){ const img = await loadImage(it.src); imgs.push(img); } const w = imgs[0].naturalWidth || imgs[0].width; const h = imgs[0].naturalHeight || imgs[0].height; const canvas = document.createElement('canvas'); canvas.width = w; canvas.height = h; const ctx = canvas.getContext('2d'); const stream = canvas.captureStream(5); const recorder = new MediaRecorder(stream,{mimeType:'video/webm;codecs=vp8'}); const chunks = []; recorder.ondataavailable = e => chunks.push(e.data); recorder.start(); for(const im of imgs){ ctx.drawImage(im,0,0,w,h); await new Promise(r=>setTimeout(r,200)); } recorder.stop(); await new Promise(r=>recorder.onstop = r); const blob = new Blob(chunks,{type:'video/webm'}); const id = 'tl_' + Math.random().toString(36).slice(2,8); state.timelapses.push({id,blob}); renderTimelapses(); showTab('timelapses'); log('Таймлапс создан: '+id); }

function renderTimelapses(){ const c = $('timelapsesList'); c.innerHTML=''; state.timelapses.forEach(t=>{ const div = document.createElement('div'); div.style.display='flex'; div.style.justifyContent='space-between'; div.style.alignItems='center'; div.style.padding='8px'; div.style.border='1px solid rgba(255,255,255,0.03)'; div.style.borderRadius='6px'; const title = document.createElement('div'); title.textContent = t.id; const actions = document.createElement('div'); const btnPlay = document.createElement('button'); btnPlay.className='btn ghost'; btnPlay.textContent='Просмотр'; btnPlay.onclick = ()=>{ const url = URL.createObjectURL(t.blob); window.open(url); }; actions.appendChild(btnPlay); div.appendChild(title); div.appendChild(actions); c.appendChild(div); }); }

// Получение кадров обратно из IPFS (через публичный gateway)
async function fetchFromIPFS(){ const cid = $('fetchCidInput').value.trim(); if(!cid){ alert('Введите CID'); return; } const gateway = 'https://ipfs.io/ipfs/'; try{ const url = gateway + cid; const resp = await fetch(url); const blob = await resp.blob(); addSnapshotToGallery(blob); log('Получено из IPFS: '+cid); }catch(e){ log('Ошибка получения: '+e.message); alert('Ошибка получения: '+e.message); } }

// CID modal
function openCIDModal(){ $('cidModal').style.display='block'; renderCIDList(); }
function closeCIDModal(){ $('cidModal').style.display='none'; }
function renderCIDList(){ const list = $('cidList'); list.innerHTML=''; const arr = loadCIDRecords(); arr.forEach((r,idx)=>{ const item = document.createElement('div'); item.className='cid-item'; item.innerHTML = `<div><strong>${r.cid}</strong><div style="font-size:.85rem;color:var(--muted)">${r.note||''}</div></div>`; const actions = document.createElement('div'); const editBtn = document.createElement('button'); editBtn.className='btn ghost'; editBtn.textContent='✏️'; editBtn.onclick = ()=>{ const newNote = prompt('Метка', r.note||''); if(newNote!==null){ r.note=newNote; saveCIDRecords(arr); renderCIDList(); } }; const delBtn = document.createElement('button'); delBtn.className='btn'; delBtn.textContent='🗑'; delBtn.onclick = ()=>{ arr.splice(idx,1); saveCIDRecords(arr); renderCIDList(); }; actions.appendChild(editBtn); actions.appendChild(delBtn); item.appendChild(actions); list.appendChild(item); }); }
function addCIDManually(){ const cid = $('newCidInput').value.trim(); const note = $('newCidNote').value.trim(); if(!cid) return; const arr = loadCIDRecords(); arr.push({cid,note,timestamp:Date.now()}); saveCIDRecords(arr); $('newCidInput').value=''; $('newCidNote').value=''; renderCIDList(); }

// ========== IDE (CodeMirror) & Pyodide ===========
let editor = null; function initEditor(){ editor = CodeMirror.fromTextArea($('ide'), {lineNumbers:true,mode:'javascript',theme:'cobalt'}); }
initEditor();
$('ideLang').addEventListener('change', ()=>{ const v = $('ideLang').value; editor.setOption('mode', v==='js'?'javascript':'python'); });
async function runIDE(){ const lang = $('ideLang').value; const code = editor.getValue(); if(lang==='js'){ try{ const fn = new Function('state','log','tf','mobilenet','runAIAnalysisOnCanvas', code); await fn(state, log, window.tf, window.mobilenet, runAIAnalysisOnCanvas); log('JS выполнен'); }catch(e){ log('Ошибка JS: '+e.message); } } else { if(!state.pyodide){ log('Загрузка Pyodide...'); state.pyodide = await loadPyodide({indexURL:'https://cdn.jsdelivr.net/pyodide/v0.24.1/full/'}); log('Pyodide загружен'); } try{ const res = await state.pyodide.runPythonAsync(code); log('Python выполнен: '+String(res).slice(0,200)); }catch(e){ log('Ошибка Python: '+e.message); } } }
function toggleApplyToModels(){ state.applyIDEToModels = !state.applyIDEToModels; log('Apply IDE to models: '+state.applyIDEToModels); }

// ========== AI: Sobel & MobileNet implementations ===========
async function runAIAnalysisOnCanvas(canvas, modelName, overlayCanvas){ if(modelName.includes('Sobel')){ log('AI:Sobel — старт'); await tf.ready(); const t = tf.tidy(()=>{ let img = tf.browser.fromPixels(canvas).mean(2).toFloat(); const expanded = img.expandDims(0).expandDims(-1); const gx = tf.tensor4d([[-1,0,1],[-2,0,2],[-1,0,1]],[3,3,1,1]); const gy = tf.tensor4d([[1,2,1],[0,0,0],[-1,-2,-1]],[3,3,1,1]); const convX = tf.conv2d(expanded,gx,1,'same'); const convY = tf.conv2d(expanded,gy,1,'same'); const mag = convX.square().add(convY.square()).sqrt().squeeze(); return mag; }); const magArr = await t.array(); const H=magArr.length,W=magArr[0].length; overlayCanvas.width = W; overlayCanvas.height = H; overlayCanvas.style.width = canvas.width + 'px'; overlayCanvas.style.height = canvas.height + 'px'; const ctx = overlayCanvas.getContext('2d'); const imgData = ctx.createImageData(W,H); const threshold = 60; let count=0; for(let y=0;y<H;y++){ for(let x=0;x<W;x++){ const v = magArr[y][x]; const idx = (y*W+x)*4; if(v>threshold){ imgData.data[idx]=255; imgData.data[idx+1]=255; imgData.data[idx+2]=255; imgData.data[idx+3]=255; count++; } else { imgData.data[idx+3]=0; } } } ctx.putImageData(imgData,0,0); log('Sobel edges: '+count); t.dispose(); return {method:'sobel',count}; }
  if(modelName.toLowerCase().includes('mobilenet')){ log('AI: MobileNet — старт'); if(!state.modelInstances.mobilenet){ state.modelInstances.mobilenet = await mobilenet.load(); log('MobileNet загружен (отложенно)'); } const preds = await state.modelInstances.mobilenet.classify(canvas); log('MobileNet: '+JSON.stringify(preds)); return {method:'mobilenet',preds}; }
  log('AI: модель не поддерживается (демо)'); return null; }

// ========== IPFS helper (демо-POST) ===========
async function uploadToIPFS(blob){ // демо: использует публичный helia endpoint — проверь политику использования
  const gateway = 'https://api.helia.io/api/v0/add'; const form = new FormData(); form.append('file', blob); const res = await fetch(gateway,{method:'POST',body:form}); const text = await res.text(); try{ const j = JSON.parse(text); const cid = j.Hash||j.cid|| (j[0] && j[0].Hash); return cid; }catch(e){ const m = text.match(/"?Hash"?\s*[:=]\s*"?([A-Za-z0-9]+)/i); if(m){ return m[1]; } throw new Error('Не удалось распарсить ответ IPFS'); } }

// ========== Misc helpers ===========
function captureImageFromVideo(videoEl){ return new Promise((res,rej)=>{ try{ const w = videoEl.videoWidth || videoEl.clientWidth || 640; const h = videoEl.videoHeight || videoEl.clientHeight || 480; const c = document.createElement('canvas'); c.width=w; c.height=h; const ctx=c.getContext('2d'); ctx.drawImage(videoEl,0,0,w,h); c.toBlob(b=>res(b),'image/png'); }catch(e){ rej(e); } }); }
function captureCanvasFromVideo(videoEl){ return new Promise((res,rej)=>{ try{ const w=videoEl.videoWidth||videoEl.clientWidth||640; const h=videoEl.videoHeight||videoEl.clientHeight||480; const c=document.createElement('canvas'); c.width=w; c.height=h; const ctx=c.getContext('2d'); ctx.drawImage(videoEl,0,0,w,h); res(c); }catch(e){ rej(e); } }); }
function loadImage(url){ return new Promise((res,rej)=>{ const img = new Image(); img.crossOrigin='anonymous'; img.onload=()=>res(img); img.onerror=(e)=>rej(e); img.src=url; }); }

// init default gallery
(function init(){ state.galleries.push({id:'g_default',name:'Main Gallery',items:[]}); renderGalleries(); log('OctoCore инициализирован'); })();

</script>
</body>
</html>
