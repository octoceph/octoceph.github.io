<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>OctoCore ‚Äî Web Dashboard (Updated)</title>

<!-- –ò–∫–æ–Ω–∫–∏: Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<!-- CodeMirror + —Ç–µ–º–∞ Cobalt –¥–ª—è IDE -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/cobalt.min.css" />

<style>
  /* --- –û–±—â–∏–µ —Å—Ç–∏–ª–∏ --- */
  :root{ --bg:#071423; --panel:#071827; --accent:#06b6d4; --muted:#94a3b8 }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:#e6eef6}

  /* –õ–µ–≤–æ–µ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –º–µ–Ω—é */
  #sidebar{position:fixed;left:0;top:0;bottom:0;width:340px;padding:16px;background:linear-gradient(180deg,#071826,#04121a);overflow:auto;border-right:1px solid rgba(255,255,255,0.03)}
  #main{margin-left:340px;padding:12px}
  h3,h4{margin:6px 0}
  .block{background:rgba(255,255,255,0.02);padding:10px;border-radius:10px;margin-bottom:12px}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:8px;border:none;cursor:pointer}
  .btn.primary{background:var(--accent);color:#012}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}

  /* Spinner */
  .spinner{width:16px;height:16px;border:2px solid rgba(255,255,255,0.2);border-top-color:white;border-radius:50%;animation:spin .8s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* –ù–∞–≤–∏–≥–∞—Ü–∏—è –≤–∫–ª–∞–¥–æ–∫ */
  nav{display:flex;gap:8px;margin-bottom:12px}
  nav button{padding:8px 12px;border-radius:8px;border:none;background:transparent;color:var(--muted);cursor:pointer}
  nav button.active{background:linear-gradient(90deg,#05343a,#024b4f);color:white}

  /* –ö–∞–º–µ—Ä—ã */
  .camera-container{display:flex;flex-wrap:wrap;gap:12px;max-width:100vw}
  .camera{position:relative;width:320px;background:#061219;border-radius:10px;padding:6px;box-shadow:0 6px 24px rgba(0,0,0,0.6)}
  .camera video,.camera img{width:100%;border-radius:8px;display:block}
  .cam-controls{position:absolute;right:8px;top:8px;display:flex;flex-direction:column;gap:6px}
  .cam-controls button{background:rgba(0,0,0,0.45);border:1px solid rgba(255,255,255,0.04);color:#e6eef6;padding:6px;border-radius:6px;cursor:pointer;width:36px;height:36px;display:flex;align-items:center;justify-content:center}
  .cam-bottom{position:absolute;left:8px;bottom:8px;display:flex;gap:6px;align-items:center}
  .cam-bottom input[type=number]{width:72px;padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#e6eef6}

  /* model select small */
  .model-select{position:absolute;right:8px;bottom:56px;background:#02171a;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);display:none}
  .model-select select{padding:6px;border-radius:6px;background:transparent;color:#e6eef6;border:1px solid rgba(255,255,255,0.04)}
  .model-select button{margin-top:6px;padding:6px;border-radius:6px;background:var(--accent);border:none;color:#012}

  /* –ì–∞–ª–µ—Ä–µ–∏ –∏ —Ç–∞–π–º–ª–∞–π–Ω—ã */
  .gallery-block{background:#071827;padding:10px;border-radius:8px;margin-bottom:12px}
  .gallery-controls{display:flex;gap:8px;align-items:center;margin-bottom:6px}
  .timeline{display:flex;gap:8px;overflow:auto;padding:6px}
  .thumb{position:relative}
  .thumb img{height:96px;border-radius:6px}
  .thumb input[type=checkbox]{position:absolute;left:6px;top:6px}

  /* CID modal */
  .modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#071423;padding:16px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);z-index:999;width:820px;max-width:95%;display:none}
  .modal h4{margin-top:0}
  .modal .row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
  .modal .cid-list{max-height:300px;overflow:auto;background:#03141a;padding:8px;border-radius:6px}
  .modal .cid-item{display:flex;justify-content:space-between;align-items:center;padding:6px;border-bottom:1px solid rgba(255,255,255,0.02)}

  /* Logs + IDE */
  #logConsole{background:#000;color:#0f0;padding:8px;font-family:monospace;height:160px;overflow:auto;border-radius:6px;border:1px solid rgba(255,255,255,0.02);white-space:pre-wrap}
  .ide{margin-top:8px}
  .ide .controls{display:flex;gap:8px;margin-bottom:6px}
  .hidden{display:none}

  /* responsive */
  @media(max-width:900px){#sidebar{position:relative;width:100%;height:auto}#main{margin-left:0}}
</style>
</head>
<body>

<!-- –°–∞–π–¥–±–∞—Ä -->
<div id="sidebar">
  <h3>OctoCore</h3>
  <div style="font-size:.9rem;color:var(--muted);margin-bottom:8px">–í–µ–± –¥–∞—à–±–æ—Ä–¥ ‚Ä¢ –∫–∞–º–µ—Ä—ã ‚Ä¢ AI ‚Ä¢ IPFS</div>

  <!-- –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å / –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å -->
  <div class="block">
    <div style="display:flex;gap:8px;align-items:center">
      <button id="scanBtn" class="btn primary" onclick="handleScanClick()"><i class="fa-solid fa-magnifying-glass"></i> –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
      <div style="position:relative">
        <button id="scanMenuBtn" class="btn ghost" onclick="toggleScanMenu()"><i class="fa-solid fa-ellipsis"></i></button>
        <div id="scanMenu" style="position:absolute;right:0;top:36px;background:#02171a;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);display:none">
          <button class="btn small" onclick="handleRestartClick()"><i class="fa-solid fa-arrows-rotate"></i> –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å</button>
        </div>
      </div>
    </div>
    <div style="font-size:.85rem;color:var(--muted);margin-top:6px">–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Ç–∏ –∏ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (–¥–µ–º–æ)</div>
  </div>

  <!-- –î–æ–±–∞–≤–∏—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫–∏ -->
  <div class="block">
    <h4>–î–æ–±–∞–≤–∏—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫</h4>
    <div style="display:flex;gap:8px;margin-bottom:8px">
      <select id="sourceType" style="flex:1;padding:8px;border-radius:6px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:#e6eef6" onchange="onSourceTypeChange()">
        <option value="web">Web-–∫–∞–º–µ—Ä–∞</option>
        <option value="ip">IP-–∫–∞–º–µ—Ä–∞</option>
      </select>
      <button class="btn" onclick="onAddSourceClick()"><i class="fa-solid fa-plus"></i></button>
    </div>
    <div id="ipFields" class="hidden">
      <input id="newIpUrl" placeholder="http://192.168.x.x/snapshot.jpg" style="width:100%;padding:8px;border-radius:6px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:#e6eef6;margin-bottom:6px" />
      <div style="display:flex;gap:6px;margin-bottom:6px">
        <input id="newIpLogin" placeholder="–õ–æ–≥–∏–Ω" style="flex:1;padding:8px;border-radius:6px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:#e6eef6" />
        <input id="newIpPass" placeholder="–ü–∞—Ä–æ–ª—å" type="password" style="width:140px;padding:8px;border-radius:6px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:#e6eef6" />
      </div>
      <button class="btn" onclick="addIPPlaceholder()">–î–æ–±–∞–≤–∏—Ç—å IP (–∑–∞–≥–ª—É—à–∫–∞)</button>
    </div>
  </div>

  <!-- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –º–æ–¥–µ–ª–∏ -->
  <div class="block">
    <h4>–ì–ª–æ–±–∞–ª—å–Ω—ã–µ –º–æ–¥–µ–ª–∏</h4>
    <div style="display:flex;gap:8px;margin-bottom:8px">
      <select id="globalModel" style="flex:1;padding:8px;border-radius:6px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:#e6eef6"></select>
      <button class="btn" onclick="uploadModel()"><i class="fa-solid fa-upload"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
    </div>
    <div style="font-size:.85rem;color:var(--muted)">–ú–æ–¥–µ–ª–∏ –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏ –¥–æ—Å—Ç—É–ø–Ω—ã –≤ –∫–∞–∂–¥–æ–π –∫–∞–º–µ—Ä–µ.</div>
  </div>

  <!-- CID modal opener + quick actions -->
  <div class="block">
    <button class="btn" onclick="openCIDModal()"><i class="fa-solid fa-database"></i> –°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ CID</button>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button class="btn ghost" onclick="scanNetwork()"><i class="fa-solid fa-network-wired"></i> –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
      <button class="btn ghost" onclick="restartCameras()"><i class="fa-solid fa-arrows-rotate"></i> –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å</button>
    </div>
  </div>

  <!-- –õ–æ–≥–∏ –∏ IDE -->
  <div class="block">
    <h4>–õ–æ–≥–∏</h4>
    <div id="logConsole"></div>
  </div>

  <div class="block">
    <h4>IDE</h4>
    <div class="ide">
      <div class="controls">
        <select id="ideLang"><option value="js">JavaScript</option><option value="py">Python</option></select>
        <button class="btn" onclick="runIDE()">–ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
        <button class="btn ghost" onclick="toggleApplyToModels()">–ü—Ä–∏–º–µ–Ω—è—Ç—å –∫ –ò–ò</button>
      </div>
      <textarea id="ide" style="width:100%;height:180px;background:#02171a;color:#e6eef6;">console.log('OctoCore IDE')</textarea>
      <div style="font-size:.8rem;color:var(--muted);margin-top:6px">Python –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è <!--—á–µ—Ä–µ–∑ Pyodide--> –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ.</div>
    </div>
  </div>
</div>

<!-- Main -->
<div id="main">
  <header>
    <div>
      <strong>OctoCore</strong>
      <div style="font-size:.85rem;color:#94a3b8">–ú—É–ª—å—Ç–∏–∫–∞–º–µ—Ä—ã, AI-–∞–Ω–∞–ª–∏–∑, IPFS</div>
    </div>
    <div>
      <button class="btn ghost" onclick="toggleSidebar()">–°–≤–µ—Ä–Ω—É—Ç—å –º–µ–Ω—é</button>
    </div>
  </header>

  <nav>
    <button id="tabBtnCams" class="active" onclick="showTab('cams')">–ö–∞–º–µ—Ä—ã</button>
    <button id="tabBtnGalleries" onclick="showTab('galleries')">–ì–∞–ª–µ—Ä–µ–∏</button>
    <button id="tabBtnTl" onclick="showTab('timelapses')">–¢–∞–π–º–ª–∞–ø—Å—ã</button>
  </nav>

  <div class="content">
    <section id="cams" class="tab active">
      <h3>–ö–∞–º–µ—Ä—ã</h3>
      <div class="camera-container" id="cameraContainer"></div>
    </section>

    <section id="galleries" class="tab" style="display:none">
      <h3>–ì–∞–ª–µ—Ä–µ–∏</h3>
      <div class="gallery-controls">
        <input id="newGalleryName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥–∞–ª–µ—Ä–µ–∏" style="padding:8px;border-radius:6px;background:#02171a;border:1px solid rgba(255,255,255,0.04);color:#e6eef6" />
        <button class="btn" onclick="createGallery()">–°–æ–∑–¥–∞—Ç—å –≥–∞–ª–µ—Ä–µ—é</button>
        <button class="btn ghost" onclick="selectAllFrames(true)">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ</button>
        <button class="btn ghost" onclick="selectAllFrames(false)">–°–Ω—è—Ç—å –≤—ã–±–æ—Ä</button>
        <button class="btn ghost" onclick="deleteSelectedFrames()"><i class="fa-solid fa-trash"></i> –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>
      </div>
      <div id="galleriesList"></div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn" onclick="sendSelectedToIPFS()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –≤ IPFS</button>
        <button class="btn" onclick="createTimelapseFromSelected()">–°–æ–∑–¥–∞—Ç—å —Ç–∞–π–º–ª–∞–ø—Å</button>
        <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
          <input id="fetchCidInput" placeholder="CID –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è" style="padding:8px;border-radius:6px;background:#02171a;border:1px solid rgba(255,255,255,0.04);color:#e6eef6" />
          <button class="btn ghost" onclick="fetchFromIPFS()">–ü–æ–ª—É—á–∏—Ç—å –∏–∑ IPFS</button>
        </div>
      </div>
    </section>

    <section id="timelapses" class="tab" style="display:none">
      <h3>–¢–∞–π–º–ª–∞–ø—Å—ã</h3>
      <div id="timelapsesList"></div>
    </section>
  </div>
</div>

<!-- CID modal -->
<div id="cidModal" class="modal">
  <h4>–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ CID (–ª–æ–∫–∞–ª—å–Ω–æ)</h4>
  <div class="row">
    <input id="newCidInput" placeholder="CID" style="flex:1;padding:8px;border-radius:6px;background:#02171a;border:1px solid rgba(255,255,255,0.04);color:#e6eef6" />
    <input id="newCidNote" placeholder="–ú–µ—Ç–∫–∞/–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" style="width:220px;padding:8px;border-radius:6px;background:#02171a;border:1px solid rgba(255,255,255,0.04);color:#e6eef6" />
    <button class="btn" onclick="addCIDManually()">–î–æ–±–∞–≤–∏—Ç—å</button>
    <button class="btn ghost" onclick="closeCIDModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
  <div class="cid-list" id="cidList"></div>
</div>

<!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏: tfjs, mobilenet, codemirror (—Å–∫—Ä–∏–ø—Ç—ã) -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.12.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0/dist/mobilenet.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/python/python.min.js"></script>

<script>
/*
  OctoCore ‚Äî –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ (WEB) –≤ –æ–¥–Ω–æ–º HTML —Ñ–∞–π–ª–µ.
  –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ –≤–Ω—É—Ç—Ä–∏ –∫–æ–¥–∞, —á—Ç–æ–±—ã —Ç—ã –º–æ–≥ –±—ã—Å—Ç—Ä–æ –ø–æ–Ω—è—Ç—å –∏ –º–µ–Ω—è—Ç—å –ª–æ–≥–∏–∫—É.

  –í–∞–∂–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
  - –õ–µ–≤–æ–µ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –º–µ–Ω—é (–≤–∫–ª—é—á–∞—è –∑–∞–≥—Ä—É–∑–∫—É/–≤—ã–±–æ—Ä –º–æ–¥–µ–ª–µ–π)
  - –ö–∞–º–µ—Ä—ã: web –∏ ip (–∑–∞–≥–ª—É—à–∫–∏), –∫–Ω–æ–ø–∫–∏ –∫–æ–º–ø–∞–∫—Ç–Ω—ã–º–∏ –∏–∫–æ–Ω–∫–∞–º–∏
  - –ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–∞–º–µ—Ä—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –µ—ë –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (–∏–Ω—Ç–µ—Ä–≤–∞–ª—ã, –∑–∞–ø–∏—Å—å, —Ç—Ä–µ–∫–∏)
  - "–°–Ω–∏–º–æ–∫" –ø—Ä–∏–º–µ–Ω—è–µ—Ç —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –∏ (–ø–µ—Ä–µ)–∑–∞–ø—É—Å–∫–∞–µ—Ç –∏–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω—É—é —Å—ä—ë–º–∫—É
  - –ì–∞–ª–µ—Ä–µ–∏: —á–µ–∫–±–æ–∫—Å—ã, —É–¥–∞–ª–µ–Ω–∏–µ –≤—ã–¥–µ–ª–µ–Ω–Ω—ã—Ö –∫–∞–¥—Ä–æ–≤, –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ IPFS (–¥–µ–º–æ), –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ IPFS
  - –¢–∞–π–º–ª–∞–ø—Å—ã: —Å–æ–∑–¥–∞—é—Ç—Å—è –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–∞–¥—Ä–æ–≤ –∏ –ø–æ—è–≤–ª—è—é—Ç—Å—è –≤–æ –≤–∫–ª–∞–¥–∫–µ –¢–∞–π–º–ª–∞–ø—Å—ã
  - –ö–æ–¥ –¥–ª—è AI-–¥–µ–º–æ: Sobel —á–µ—Ä–µ–∑ tfjs –∏ MobileNet —á–µ—Ä–µ–∑ tfjs (–ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞)
  - IDE (CodeMirror) —Å —Ç–µ–º–æ–π Cobalt; Python —á–µ—Ä–µ–∑ Pyodide –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é
*/

// --- –ü—Ä–æ—Å—Ç—ã–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –ª–æ–∫–∞–ª—å–Ω–æ ---
const CID_KEY = 'octocore_cid_records_v1';
function loadCIDRecords(){ try{ return JSON.parse(localStorage.getItem(CID_KEY)||'[]'); }catch(e){return[]} }
function saveCIDRecords(arr){ localStorage.setItem(CID_KEY, JSON.stringify(arr)); }

// –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
const state = {
  cameras: [], // {id,type,stream,el,video,overlay,intervalMs,recorder,recording,_intervalHandle}
  galleries: [], // [{id,name,items:[{id,src,blob,cid}]}]
  models: ['Sobel (tfjs)','MobileNet (tfjs)'],
  modelInstances: {},
  timelapses: [],
  pyodide: null,
  applyIDEToModels: false
};

// –£—Ç–∏–ª–∏—Ç—ã
const $ = id => document.getElementById(id);
function log(msg){ const el=$('logConsole'); const ts = new Date().toLocaleTimeString(); el.innerHTML += `[${ts}] ${msg}<br>`; el.scrollTop = el.scrollHeight; }

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–µ–ª–∏ mobileNet –∑–∞—Ä–∞–Ω–µ–µ
(async function preload(){ try{ log('–ó–∞–≥—Ä—É–∑–∫–∞ MobileNet...'); state.modelInstances.mobilenet = await mobilenet.load(); log('MobileNet –∑–∞–≥—Ä—É–∂–µ–Ω'); }catch(e){ log('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ MobileNet: '+e.message); } })();

// ========== SCAN / RESTART UI ===========
// --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∫–ª–∞–¥–∫–∞–º–∏ –∏ —Å–∞–π–¥–±–∞—Ä–æ–º ---
let sidebarVisible = true; // —Ñ–ª–∞–≥ –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Å–∞–π–¥–±–∞—Ä–∞

/**
 * showTab(id)
 * –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –≤–∏–¥–∏–º—ã–µ —Å–µ–∫—Ü–∏–∏: 'cams', 'galleries', 'timelapses'
 * –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç –∫–ª–∞—Å—Å active —É –∫–Ω–æ–ø–æ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏.
 */
function showTab(id){
  // –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –≤–∫–ª–∞–¥–æ–∫
  const tabs = ['cams','galleries','timelapses'];
  // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é
  tabs.forEach(t=>{ const el = $(t); if(el) el.style.display = (t===id)?'block':'none'; });
  // –£–±–∏—Ä–∞–µ–º active —É –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ –∏ —Å—Ç–∞–≤–∏–º –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é
  document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
  const map = { cams: 'tabBtnCams', galleries: 'tabBtnGalleries', timelapses: 'tabBtnTl' };
  const btnId = map[id]; if(btnId && $(btnId)) $(btnId).classList.add('active');
}

/**
 * toggleSidebar()
 * –°–∫—Ä—ã–≤–∞–µ—Ç –∏–ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ª–µ–≤–æ–µ –º–µ–Ω—é –∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ—Ç –æ—Ç—Å—Ç—É–ø –æ—Å–Ω–æ–≤–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏.
 */
function toggleSidebar(){
  const sb = $('sidebar'); const main = $('main'); if(!sb || !main) return;
  sidebarVisible = !sidebarVisible;
  if(sidebarVisible){ sb.style.display = 'block'; main.style.marginLeft = '340px'; }
  else { sb.style.display = 'none'; main.style.marginLeft = '0'; }
}

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤ window —á—Ç–æ–±—ã inline onclick/onchange –≤—Å–µ–≥–¥–∞ –Ω–∞—Ö–æ–¥–∏–ª–∏ —Ñ—É–Ω–∫—Ü–∏–∏
window.showTab = showTab; window.toggleSidebar = toggleSidebar;

// –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è toggleScanMenu (–æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
function toggleScanMenu(){ const el=$('scanMenu'); el.style.display = el.style.display==='none'?'block':'none'; }
async function handleScanClick(){ const btn=$('scanBtn'); const old = btn.innerHTML; btn.innerHTML = '<span class="spinner"></span> –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ...'; log('–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (–¥–µ–º–æ) –∑–∞–ø—É—â–µ–Ω–æ'); await new Promise(r=>setTimeout(r,4000)); btn.innerHTML = old; log('–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ (–¥–µ–º–æ)'); }
async function handleRestartClick(){ $('scanMenu').style.display='none'; const btn=$('scanBtn'); const old = btn.innerHTML; btn.innerHTML = '<span class="spinner"></span> –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫...'; log('–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ (–¥–µ–º–æ)'); await new Promise(r=>setTimeout(r,4000)); btn.innerHTML = old; log('–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∑–∞–≤–µ—Ä—à—ë–Ω'); }

// ========== ADD SOURCES ===========
function onSourceTypeChange(){ const t=$('sourceType').value; $('ipFields').classList.toggle('hidden', t!=='ip'); }
function onAddSourceClick(){ const t=$('sourceType').value; if(t==='web'){ addCamera(); } else { $('ipFields').classList.remove('hidden'); } }

// –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–ª—É—à–∫—É IP-–∫–∞–º–µ—Ä—ã, –Ω–æ —Å —Ç–µ–º–∏ –∂–µ –∫–æ–Ω—Ç—Ä–æ–ª–∞–º–∏ —á—Ç–æ –∏ —É Web-–∫–∞–º–µ—Ä—ã
function addIPPlaceholder(){ const url = $('newIpUrl').value.trim(); const login = $('newIpLogin').value.trim(); const pass = $('newIpPass').value.trim(); if(!url){ alert('–í–≤–µ–¥–∏—Ç–µ URL'); return; }
  const id = 'cam_ip_' + Math.random().toString(36).slice(2,8);
  const el = document.createElement('div'); el.className='camera'; el.dataset.camId = id;
  const img = document.createElement('img'); img.src = url; img.alt = 'IP placeholder';
  const overlay = document.createElement('canvas'); overlay.style.position='absolute'; overlay.style.left='6px'; overlay.style.top='6px'; overlay.style.pointerEvents='none'; overlay.style.borderRadius='8px';

  // controls: AI, record (disabled for ip placeholder), delete
  const controls = document.createElement('div'); controls.className='cam-controls';
  const btnAI = document.createElement('button'); btnAI.innerHTML='<i class="fa-solid fa-robot"></i>'; btnAI.title='–ò–ò';
  const btnRecord = document.createElement('button'); btnRecord.innerHTML='<i class="fa-solid fa-circle"></i>'; btnRecord.title='–ó–∞–ø–∏—Å—å'; btnRecord.disabled = true;
  const btnDel = document.createElement('button'); btnDel.innerHTML='<i class="fa-solid fa-trash"></i>'; btnDel.title='–£–¥–∞–ª–∏—Ç—å';
  btnDel.onclick = ()=>{ const cam = state.cameras.find(c=>c.id===id); if(cam){ if(cam._intervalHandle) clearInterval(cam._intervalHandle); if(cam.recorder && cam.recording) cam.recorder.stop(); } el.remove(); state.cameras = state.cameras.filter(c=>c.id!==id); log('IP –∫–∞–º–µ—Ä–∞ —É–¥–∞–ª–µ–Ω–∞: '+id); };
  controls.appendChild(btnAI); controls.appendChild(btnRecord); controls.appendChild(btnDel);

  // bottom: snapshot + interval
  const bottom = document.createElement('div'); bottom.className='cam-bottom';
  const snap = document.createElement('button'); snap.className='btn'; snap.innerHTML='<i class="fa-solid fa-camera"></i>'; snap.title='–°–Ω–∏–º–æ–∫';
  snap.onclick = async ()=>{
    // –ø—Ä–∏–º–µ–Ω—è–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –∏ –ø—ã—Ç–∞–µ–º—Å—è –≤–∑—è—Ç—å —Å–Ω–∏–º–æ–∫ –ø–æ URL; –µ—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏—Ç—Å—è ‚Äî fallback —Ä–∏—Å—É–µ–º —Ç–µ–∫—É—â—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É
    const intInput = bottom.querySelector('input[type=number]'); const val = parseInt(intInput.value,10) || 5;
    const cam = state.cameras.find(c=>c.id===id); if(cam){ cam.intervalMs = val*1000; startIntervalCapture(id); }
    try{ const resp = await fetch(url); if(resp.ok){ const blob = await resp.blob(); addSnapshotToGallery(blob); log('–°–Ω–∏–º–æ–∫ IP –¥–æ–±–∞–≤–ª–µ–Ω: '+url); return; } }
    catch(e){ /* ignore fetch error */ }
    // fallback: draw img into canvas
    try{ const c = document.createElement('canvas'); c.width = img.naturalWidth || 320; c.height = img.naturalHeight || 180; const ctx = c.getContext('2d'); ctx.drawImage(img,0,0,c.width,c.height); c.toBlob(b=>{ addSnapshotToGallery(b); log('–°–Ω–∏–º–æ–∫ (fallback) –¥–æ–±–∞–≤–ª–µ–Ω –∏–∑ –∑–∞–≥–ª—É—à–∫–∏'); }); }catch(e){ log('–û—à–∏–±–∫–∞ —Å–Ω—è—Ç–∏—è —Å IP-–∑–∞–≥–ª—É—à–∫–∏: '+e.message); }
  };
  const interval = document.createElement('input'); interval.type='number'; interval.min=1; interval.value=5; interval.title='–ò–Ω—Ç–µ—Ä–≤–∞–ª (—Å–µ–∫)'; interval.onchange=()=>{ const cam = state.cameras.find(c=>c.id===id); if(cam) cam.intervalMs = parseInt(interval.value,10)*1000; };
  bottom.appendChild(snap); bottom.appendChild(interval);

  // model select for IP placeholder
  const modelBox = document.createElement('div'); modelBox.className='model-select'; modelBox.style.display='none';
  const select = document.createElement('select'); select.innerHTML = state.models.map(m=>`<option>${m}</option>`).join('');
  const runBtn = document.createElement('button'); runBtn.textContent='Run'; runBtn.onclick = async ()=>{ const modelName = select.value; log('AI run '+modelName+' on '+id); try{ const c = document.createElement('canvas'); c.width = img.naturalWidth||img.clientWidth||320; c.height = img.naturalHeight||img.clientHeight||180; const ctx = c.getContext('2d'); ctx.drawImage(img,0,0,c.width,c.height); await runAIAnalysisOnCanvas(c, modelName, overlay); }catch(e){ log('AI error on IP: '+e.message); } };
  modelBox.appendChild(select); modelBox.appendChild(runBtn);

  el.appendChild(img); el.appendChild(overlay); el.appendChild(controls); el.appendChild(bottom); el.appendChild(modelBox);
  $('cameraContainer').appendChild(el);
  state.cameras.push({ id, type:'ip', url, login, pass, el, overlay, intervalMs:5000, recorder:null, recording:false, _intervalHandle:null });
  log('IP placeholder –¥–æ–±–∞–≤–ª–µ–Ω–∞: '+url);
}

// ========== WEB CAMERA ===========
async function addCamera(){ try{ const stream = await navigator.mediaDevices.getUserMedia({video:true,audio:false}); createWebCameraCard(stream); log('–í–µ–±-–∫–∞–º–µ—Ä–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞'); }catch(e){ log('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ: '+(e.message||e)); alert('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ: '+(e.message||e)); } }

function createWebCameraCard(stream){ const id='cam_'+Math.random().toString(36).slice(2,9); const el=document.createElement('div'); el.className='camera'; el.dataset.camId=id; const video=document.createElement('video'); video.autoplay=true; video.playsInline=true; video.muted=true; video.srcObject=stream; const overlay=document.createElement('canvas'); overlay.style.position='absolute'; overlay.style.left='6px'; overlay.style.top='6px'; overlay.style.pointerEvents='none'; overlay.style.borderRadius='8px';
  // controls (compact icons)
  const controls=document.createElement('div'); controls.className='cam-controls';
  const btnAI=document.createElement('button'); btnAI.innerHTML='<i class="fa-solid fa-robot"></i>'; btnAI.title='–ò–ò';
  const btnRecord=document.createElement('button'); btnRecord.innerHTML='<i class="fa-solid fa-circle"></i>'; btnRecord.title='–ó–∞–ø–∏—Å—å';
  const btnDel=document.createElement('button'); btnDel.innerHTML='<i class="fa-solid fa-trash"></i>'; btnDel.title='–£–¥–∞–ª–∏—Ç—å';

  // —É–¥–∞–ª–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã, –∑–∞–ø–∏—Å—å –∏ —Ç—Ä–µ–∫–∏
  btnDel.onclick = ()=>{
    const cam = state.cameras.find(c=>c.id===id);
    if(cam){ if(cam._intervalHandle) clearInterval(cam._intervalHandle); cam._intervalHandle = null; if(cam.recorder && cam.recording){ try{ cam.recorder.stop(); }catch(e){} cam.recording=false; } try{ if(cam.stream) cam.stream.getTracks().forEach(t=>t.stop()); }catch(e){}
    }
    el.remove(); state.cameras = state.cameras.filter(c=>c.id!==id); log('–ö–∞–º–µ—Ä–∞ —É–¥–∞–ª–µ–Ω–∞: '+id);
  };

  btnAI.onclick = ()=>{ modelBox.style.display = modelBox.style.display==='block'?'none':'block'; };
  btnRecord.onclick = ()=> toggleRecording(id);
  controls.appendChild(btnAI); controls.appendChild(btnRecord); controls.appendChild(btnDel);

  // bottom: snapshot + interval
  const bottom = document.createElement('div'); bottom.className='cam-bottom';
  const snap = document.createElement('button'); snap.className='btn'; snap.innerHTML='<i class="fa-solid fa-camera"></i>'; snap.title='–°–Ω–∏–º–æ–∫';
  snap.onclick = async ()=>{
    // –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ "–°–Ω–∏–º–æ–∫" –ø—Ä–∏–º–µ–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ –ø–æ–ª—è –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –∏ (–ø–µ—Ä–µ)–∑–∞–ø—É—Å–∫–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω—É—é —Å—ä—ë–º–∫—É
    const cam = state.cameras.find(c=>c.id===id);
    const intInput = bottom.querySelector('input[type=number]'); const val = parseInt(intInput.value,10) || 5;
    if(cam){ cam.intervalMs = val*1000; startIntervalCapture(id); }
    try{ const blob = await captureImageFromVideo(video); addSnapshotToGallery(blob); log('–°–Ω–∏–º–æ–∫ —Å–¥–µ–ª–∞–Ω: '+id+' (–∏–Ω—Ç–µ—Ä–≤–∞–ª '+val+'s)'); }catch(e){ log('–û—à–∏–±–∫–∞ —Å–Ω–∏–º–∫–∞: '+e.message); }
  };
  const interval = document.createElement('input'); interval.type='number'; interval.min=1; interval.value=5; interval.title='–ò–Ω—Ç–µ—Ä–≤–∞–ª (—Å–µ–∫)'; interval.onchange = ()=>{ const cam=state.cameras.find(c=>c.id===id); if(cam) cam.intervalMs = parseInt(interval.value,10)*1000; };
  bottom.appendChild(snap); bottom.appendChild(interval);

  // model select box
  const modelBox = document.createElement('div'); modelBox.className='model-select'; modelBox.style.display='none';
  const select = document.createElement('select'); select.innerHTML = state.models.map(m=>`<option>${m}</option>`).join('');
  const run = document.createElement('button'); run.textContent='Run'; run.onclick = async ()=>{ const modelName = select.value; log('AI run '+modelName+' on '+id); const canvas = await captureCanvasFromVideo(video); await runAIAnalysisOnCanvas(canvas, modelName, overlay); };
  const toggleOverlayBtn = document.createElement('button'); toggleOverlayBtn.textContent='Toggle'; toggleOverlayBtn.onclick=()=>{ overlay.style.display = overlay.style.display==='none'?'block':'none'; };
  modelBox.appendChild(select); modelBox.appendChild(run); modelBox.appendChild(toggleOverlayBtn);

  el.appendChild(video); el.appendChild(overlay); el.appendChild(controls); el.appendChild(bottom); el.appendChild(modelBox);
  $('cameraContainer').appendChild(el);
  state.cameras.push({ id, type:'web', stream, el, video, overlay, intervalMs:5000, recorder:null, recording:false, _intervalHandle:null });

  // –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º overlay –ø–æ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º –∏ —Å—Ç–∞—Ä—Ç—É–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω—É—é —Å—ä—ë–º–∫—É
  video.addEventListener('loadedmetadata', ()=>{ overlay.width = video.videoWidth || video.clientWidth; overlay.height = video.videoHeight || video.clientHeight; overlay.style.width = video.clientWidth + 'px'; overlay.style.height = video.clientHeight + 'px'; overlay.style.display='none'; });
  startIntervalCapture(id);
}

// –§—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ —Å—ä—ë–º–∫–∏ ‚Äî —É—á–∏—Ç—ã–≤–∞–µ—Ç —Ç–∏–ø –∫–∞–º–µ—Ä—ã
function startIntervalCapture(id){ const cam = state.cameras.find(c=>c.id===id); if(!cam) return; if(cam._intervalHandle) clearInterval(cam._intervalHandle);
  cam._intervalHandle = setInterval(async ()=>{
    if(cam.type === 'web' && cam.video){ try{ const blob = await captureImageFromVideo(cam.video); addSnapshotToGallery(blob); log('–ò–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω—ã–π —Å–Ω–∏–º–æ–∫: '+id); }catch(e){ log('–û—à–∏–±–∫–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω–æ–≥–æ —Å–Ω–∏–º–∫–∞: '+e.message); } }
    else if(cam.type === 'ip'){ try{ const resp = await fetch(cam.url); if(resp.ok){ const blob = await resp.blob(); addSnapshotToGallery(blob); log('–ò–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω—ã–π snapshot (IP): '+id); } }catch(e){ /* ignore */ } }
  }, cam.intervalMs);
}

// –ó–∞–ø–∏—Å—å –≤–∏–¥–µ–æ —á–µ—Ä–µ–∑ MediaRecorder
function toggleRecording(id){ const cam = state.cameras.find(c=>c.id===id); if(!cam) return; if(cam.recording){ cam.recorder.stop(); cam.recording=false; log('–ó–∞–ø–∏—Å—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞: '+id); } else { const stream = cam.stream; if(!stream){ log('–ù–µ—Ç —Å—Ç—Ä–∏–º–∞ –¥–ª—è –∑–∞–ø–∏—Å–∏'); return; } const recorder = new MediaRecorder(stream,{mimeType:'video/webm;codecs=vp8'}); cam.chunks = []; recorder.ondataavailable = e=>cam.chunks.push(e.data); recorder.onstop = ()=>{ const blob = new Blob(cam.chunks,{type:'video/webm'}); addSnapshotToGallery(blob); log('–í–∏–¥–µ–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –≥–∞–ª–µ—Ä–µ—é: '+id); }; cam.recorder = recorder; cam.recording = true; recorder.start(); log('–ó–∞–ø–∏—Å—å –∑–∞–ø—É—â–µ–Ω–∞: '+id); } }

// ================== GALLERIES ==================
function createGallery(){ const name = $('newGalleryName').value.trim() || ('Gallery ' + (state.galleries.length+1)); const id = 'g_' + Math.random().toString(36).slice(2,8); state.galleries.push({id,name,items:[]}); renderGalleries(); $('newGalleryName').value=''; log('–ì–∞–ª–µ—Ä–µ—è —Å–æ–∑–¥–∞–Ω–∞: '+name); }

function addSnapshotToGallery(blob){ if(state.galleries.length===0) createGallery(); const g = state.galleries[0]; const id = 'it_' + Math.random().toString(36).slice(2,8); const url = URL.createObjectURL(blob); g.items.push({id,src:url,blob,cid:null}); renderGalleries(); }

function renderGalleries(){
  // –†–µ–Ω–¥–µ—Ä –≤—Å–µ—Ö –≥–∞–ª–µ—Ä–µ–π ‚Äî —Å–æ–∑–¥–∞—ë–º –æ—Ç–¥–µ–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–π –≥–∞–ª–µ—Ä–µ–∏ –∏ –µ—ë —Ç–∞–π–º–ª–∞–π–Ω–∞
  const container = $('galleriesList');
  container.innerHTML = '';
  state.galleries.forEach(g => {
    const block = document.createElement('div');
    block.className = 'gallery-block';

    const header = document.createElement('div');
    header.style.display = 'flex';
    header.style.justifyContent = 'space-between';
    header.innerHTML = `<strong>${g.name}</strong> <span style="color:var(--muted)">${g.items.length} items</span>`;

    const timeline = document.createElement('div');
    timeline.className = 'timeline';

    g.items.forEach(it => {
      const t = document.createElement('div');
      t.className = 'thumb';
      t.style.position = 'relative';

      const img = document.createElement('img');
      img.src = it.src;
      img.alt = it.id;

      // –ß–µ–∫–±–æ–∫—Å —Ç–µ–ø–µ—Ä—å —Ö—Ä–∞–Ω–∏—Ç id –∫–∞–¥—Ä–∞ –≤ data-–∞—Ç—Ä–∏–±—É—Ç–µ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è —Å state.selectedFrames
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.dataset.itemId = it.id;
      cb.style.position = 'absolute';
      cb.style.left = '6px';
      cb.style.top = '6px';
      // –±–µ–∑–æ–ø–∞—Å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è Set
      cb.checked = !!(state.selectedFrames && typeof state.selectedFrames.has === 'function' && state.selectedFrames.has(it.id));

      // –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —á–µ–∫–±–æ–∫—Å–∞ –æ–±–Ω–æ–≤–ª—è–µ–º Set ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º add/delete
      cb.addEventListener('change', () => {
        if(!state.selectedFrames) state.selectedFrames = new Set();
        if(cb.checked) state.selectedFrames.add(it.id);
        else state.selectedFrames.delete(it.id);
      });

      t.appendChild(cb);
      t.appendChild(img);
      timeline.appendChild(t);
    });

    block.appendChild(header);
    block.appendChild(timeline);
    container.appendChild(block);
  });
}

// selectedFrames set utility
state.selectedFrames = new Set();

function selectAllFrames(flag){
  // flag=true -> –≤—ã–±—Ä–∞—Ç—å –≤—Å–µ, flag=false -> —Å–Ω—è—Ç—å –≤—ã–±–æ—Ä
  if(!state.selectedFrames) state.selectedFrames = new Set();
  if(flag){
    state.galleries.forEach(g => g.items.forEach(it => state.selectedFrames.add(it.id)));
  } else {
    state.selectedFrames.clear();
  }

  // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —á–µ–∫–±–æ–∫—Å—ã –≤ DOM (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä–∏–≤–∞—Ç—å –≤—Å—é –≥–∞–ª–µ—Ä–µ—é)
  const checkboxes = document.querySelectorAll('#galleriesList input[type=checkbox]');
  checkboxes.forEach(cb => {
    const id = cb.dataset.itemId;
    cb.checked = state.selectedFrames.has(id);
  });
}

function deleteSelectedFrames(){ if(state.selectedFrames.size===0){ alert('–ù–µ—Ç –≤—ã–¥–µ–ª–µ–Ω–Ω—ã—Ö –∫–∞–¥—Ä–æ–≤'); return; } state.galleries.forEach(g=>{ g.items = g.items.filter(it=> !state.selectedFrames.has(it.id)); }); state.selectedFrames.clear(); renderGalleries(); log('–í—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–∞–¥—Ä—ã —É–¥–∞–ª–µ–Ω—ã'); }

// –û—Ç–ø—Ä–∞–≤–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –≤ IPFS (–¥–µ–º–æ —á–µ—Ä–µ–∑ public gateway / helia API)
async function sendSelectedToIPFS(){ const selected = []; state.galleries.forEach(g=>g.items.forEach(it=>{ if(state.selectedFrames.has(it.id)) selected.push(it); })); if(selected.length===0){ alert('–ù–µ—Ç –≤—ã–¥–µ–ª–µ–Ω–Ω—ã—Ö –∫–∞–¥—Ä–æ–≤'); return; } log('–û—Ç–ø—Ä–∞–≤–∫–∞ '+selected.length+' —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ IPFS'); for(const it of selected){ try{ let blob = it.blob; if(!blob){ const resp = await fetch(it.src); blob = await resp.blob(); } const cid = await uploadToIPFS(blob); it.cid = cid; saveCIDRecords(loadCIDRecords().concat([{cid,note:'uploaded',ts:Date.now()}])); log('–ó–∞–≥—Ä—É–∂–µ–Ω –≤ IPFS: '+cid); }catch(e){ log('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: '+e.message); } } renderGalleries(); }

// –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–π–º–ª–∞–ø—Å–∞ –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–∞–¥—Ä–æ–≤ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ state.timelapses
async function createTimelapseFromSelected(){ const selected=[]; state.galleries.forEach(g=>g.items.forEach(it=>{ if(state.selectedFrames.has(it.id)) selected.push(it); })); if(selected.length<2){ alert('–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 2 –∫–∞–¥—Ä–∞'); return; } log('–°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–π–º–ª–∞–ø—Å–∞ –∏–∑ '+selected.length+' –∫–∞–¥—Ä–æ–≤'); const imgs=[]; for(const it of selected){ const img = await loadImage(it.src); imgs.push(img); } const w = imgs[0].naturalWidth || imgs[0].width; const h = imgs[0].naturalHeight || imgs[0].height; const canvas = document.createElement('canvas'); canvas.width = w; canvas.height = h; const ctx = canvas.getContext('2d'); const stream = canvas.captureStream(5); const recorder = new MediaRecorder(stream,{mimeType:'video/webm;codecs=vp8'}); const chunks = []; recorder.ondataavailable = e => chunks.push(e.data); recorder.start(); for(const im of imgs){ ctx.drawImage(im,0,0,w,h); await new Promise(r=>setTimeout(r,200)); } recorder.stop(); await new Promise(r=>recorder.onstop = r); const blob = new Blob(chunks,{type:'video/webm'}); const id = 'tl_' + Math.random().toString(36).slice(2,8); state.timelapses.push({id,blob}); renderTimelapses(); showTab('timelapses'); log('–¢–∞–π–º–ª–∞–ø—Å —Å–æ–∑–¥–∞–Ω: '+id); }

function renderTimelapses(){ const c = $('timelapsesList'); c.innerHTML=''; state.timelapses.forEach(t=>{ const div = document.createElement('div'); div.style.display='flex'; div.style.justifyContent='space-between'; div.style.alignItems='center'; div.style.padding='8px'; div.style.border='1px solid rgba(255,255,255,0.03)'; div.style.borderRadius='6px'; const title = document.createElement('div'); title.textContent = t.id; const actions = document.createElement('div'); const btnPlay = document.createElement('button'); btnPlay.className='btn ghost'; btnPlay.textContent='–ü—Ä–æ—Å–º–æ—Ç—Ä'; btnPlay.onclick = ()=>{ const url = URL.createObjectURL(t.blob); window.open(url); }; actions.appendChild(btnPlay); div.appendChild(title); div.appendChild(actions); c.appendChild(div); }); }

// –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–∞–¥—Ä–æ–≤ –æ–±—Ä–∞—Ç–Ω–æ –∏–∑ IPFS (—á–µ—Ä–µ–∑ –ø—É–±–ª–∏—á–Ω—ã–π gateway)
async function fetchFromIPFS(){ const cid = $('fetchCidInput').value.trim(); if(!cid){ alert('–í–≤–µ–¥–∏—Ç–µ CID'); return; } const gateway = 'https://ipfs.io/ipfs/'; try{ const url = gateway + cid; const resp = await fetch(url); const blob = await resp.blob(); addSnapshotToGallery(blob); log('–ü–æ–ª—É—á–µ–Ω–æ –∏–∑ IPFS: '+cid); }catch(e){ log('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è: '+e.message); alert('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è: '+e.message); } }

// CID modal
function openCIDModal(){ $('cidModal').style.display='block'; renderCIDList(); }
function closeCIDModal(){ $('cidModal').style.display='none'; }
function renderCIDList(){ const list = $('cidList'); list.innerHTML=''; const arr = loadCIDRecords(); arr.forEach((r,idx)=>{ const item = document.createElement('div'); item.className='cid-item'; item.innerHTML = `<div><strong>${r.cid}</strong><div style="font-size:.85rem;color:var(--muted)">${r.note||''}</div></div>`; const actions = document.createElement('div'); const editBtn = document.createElement('button'); editBtn.className='btn ghost'; editBtn.textContent='‚úèÔ∏è'; editBtn.onclick = ()=>{ const newNote = prompt('–ú–µ—Ç–∫–∞', r.note||''); if(newNote!==null){ r.note=newNote; saveCIDRecords(arr); renderCIDList(); } }; const delBtn = document.createElement('button'); delBtn.className='btn'; delBtn.textContent='üóë'; delBtn.onclick = ()=>{ arr.splice(idx,1); saveCIDRecords(arr); renderCIDList(); }; actions.appendChild(editBtn); actions.appendChild(delBtn); item.appendChild(actions); list.appendChild(item); }); }
function addCIDManually(){ const cid = $('newCidInput').value.trim(); const note = $('newCidNote').value.trim(); if(!cid) return; const arr = loadCIDRecords(); arr.push({cid,note,timestamp:Date.now()}); saveCIDRecords(arr); $('newCidInput').value=''; $('newCidNote').value=''; renderCIDList(); }

// ========== IDE (CodeMirror) & Pyodide ===========
let editor = null; function initEditor(){ editor = CodeMirror.fromTextArea($('ide'), {lineNumbers:true,mode:'javascript',theme:'cobalt'}); }
initEditor();
$('ideLang').addEventListener('change', ()=>{ const v = $('ideLang').value; editor.setOption('mode', v==='js'?'javascript':'python'); });
async function runIDE(){ const lang = $('ideLang').value; const code = editor.getValue(); if(lang==='js'){ try{ const fn = new Function('state','log','tf','mobilenet','runAIAnalysisOnCanvas', code); await fn(state, log, window.tf, window.mobilenet, runAIAnalysisOnCanvas); log('JS –≤—ã–ø–æ–ª–Ω–µ–Ω'); }catch(e){ log('–û—à–∏–±–∫–∞ JS: '+e.message); } } else { if(!state.pyodide){ log('–ó–∞–≥—Ä—É–∑–∫–∞ Pyodide...'); state.pyodide = await loadPyodide({indexURL:'https://cdn.jsdelivr.net/pyodide/v0.24.1/full/'}); log('Pyodide –∑–∞–≥—Ä—É–∂–µ–Ω'); } try{ const res = await state.pyodide.runPythonAsync(code); log('Python –≤—ã–ø–æ–ª–Ω–µ–Ω: '+String(res).slice(0,200)); }catch(e){ log('–û—à–∏–±–∫–∞ Python: '+e.message); } } }
function toggleApplyToModels(){ state.applyIDEToModels = !state.applyIDEToModels; log('Apply IDE to models: '+state.applyIDEToModels); }

// ========== AI: Sobel & MobileNet implementations ===========
async function runAIAnalysisOnCanvas(canvas, modelName, overlayCanvas){ if(modelName.includes('Sobel')){ log('AI:Sobel ‚Äî —Å—Ç–∞—Ä—Ç'); await tf.ready(); const t = tf.tidy(()=>{ let img = tf.browser.fromPixels(canvas).mean(2).toFloat(); const expanded = img.expandDims(0).expandDims(-1); const gx = tf.tensor4d([[-1,0,1],[-2,0,2],[-1,0,1]],[3,3,1,1]); const gy = tf.tensor4d([[1,2,1],[0,0,0],[-1,-2,-1]],[3,3,1,1]); const convX = tf.conv2d(expanded,gx,1,'same'); const convY = tf.conv2d(expanded,gy,1,'same'); const mag = convX.square().add(convY.square()).sqrt().squeeze(); return mag; }); const magArr = await t.array(); const H=magArr.length,W=magArr[0].length; overlayCanvas.width = W; overlayCanvas.height = H; overlayCanvas.style.width = canvas.width + 'px'; overlayCanvas.style.height = canvas.height + 'px'; const ctx = overlayCanvas.getContext('2d'); const imgData = ctx.createImageData(W,H); const threshold = 60; let count=0; for(let y=0;y<H;y++){ for(let x=0;x<W;x++){ const v = magArr[y][x]; const idx = (y*W+x)*4; if(v>threshold){ imgData.data[idx]=255; imgData.data[idx+1]=255; imgData.data[idx+2]=255; imgData.data[idx+3]=255; count++; } else { imgData.data[idx+3]=0; } } } ctx.putImageData(imgData,0,0); log('Sobel edges: '+count); t.dispose(); return {method:'sobel',count}; }
  if(modelName.toLowerCase().includes('mobilenet')){ log('AI: MobileNet ‚Äî —Å—Ç–∞—Ä—Ç'); if(!state.modelInstances.mobilenet){ state.modelInstances.mobilenet = await mobilenet.load(); log('MobileNet –∑–∞–≥—Ä—É–∂–µ–Ω (–æ—Ç–ª–æ–∂–µ–Ω–Ω–æ)'); } const preds = await state.modelInstances.mobilenet.classify(canvas); log('MobileNet: '+JSON.stringify(preds)); return {method:'mobilenet',preds}; }
  log('AI: –º–æ–¥–µ–ª—å –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è (–¥–µ–º–æ)'); return null; }

// ========== IPFS helper (–¥–µ–º–æ-POST) ===========
async function uploadToIPFS(blob){ // –¥–µ–º–æ: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—É–±–ª–∏—á–Ω—ã–π helia endpoint ‚Äî –ø—Ä–æ–≤–µ—Ä—å –ø–æ–ª–∏—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
  const gateway = 'https://api.helia.io/api/v0/add'; const form = new FormData(); form.append('file', blob); const res = await fetch(gateway,{method:'POST',body:form}); const text = await res.text(); try{ const j = JSON.parse(text); const cid = j.Hash||j.cid|| (j[0] && j[0].Hash); return cid; }catch(e){ const m = text.match(/"?Hash"?\s*[:=]\s*"?([A-Za-z0-9]+)/i); if(m){ return m[1]; } throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –æ—Ç–≤–µ—Ç IPFS'); } }

// ========== Misc helpers ===========
function captureImageFromVideo(videoEl){ return new Promise((res,rej)=>{ try{ const w = videoEl.videoWidth || videoEl.clientWidth || 640; const h = videoEl.videoHeight || videoEl.clientHeight || 480; const c = document.createElement('canvas'); c.width=w; c.height=h; const ctx=c.getContext('2d'); ctx.drawImage(videoEl,0,0,w,h); c.toBlob(b=>res(b),'image/png'); }catch(e){ rej(e); } }); }
function captureCanvasFromVideo(videoEl){ return new Promise((res,rej)=>{ try{ const w=videoEl.videoWidth||videoEl.clientWidth||640; const h=videoEl.videoHeight||videoEl.clientHeight||480; const c=document.createElement('canvas'); c.width=w; c.height=h; const ctx=c.getContext('2d'); ctx.drawImage(videoEl,0,0,w,h); res(c); }catch(e){ rej(e); } }); }
function loadImage(url){ return new Promise((res,rej)=>{ const img = new Image(); img.crossOrigin='anonymous'; img.onload=()=>res(img); img.onerror=(e)=>rej(e); img.src=url; }); }

// init default gallery
(function init(){ state.galleries.push({id:'g_default',name:'Main Gallery',items:[]}); renderGalleries(); log('OctoCore –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω'); })();

</script>
</body>
</html>
